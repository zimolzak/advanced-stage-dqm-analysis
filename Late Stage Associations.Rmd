---
title: "Late Stage Associations"
author: "Andrew Zimolzak, MD, MMSc"
date: "`r Sys.Date()`"
output: pdf_document
---



# Intro

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(knitr)
library(tidyr)
library(Hmisc)

knitr::opts_chunk$set(echo = FALSE)
```

```{r read, include=FALSE}
lung_raw <- read_csv("VA Lung comprehensive.csv") %>%
  mutate(cancer_type = "Lung")

colon_raw <- read_csv("VA Colon comprehensive.csv") %>%
  mutate(cancer_type = "Colon")

# FIXME - IsLate is a factor.
```

```{r tidying}
all_data <- bind_rows(colon_raw, lung_raw) %>%
  mutate(
    Sex = case_when(PatientSex == 1 ~ "M",TRUE ~ "F"),
    IsLate = case_when(
      IsLate == 0 ~ "Early",
      IsLate == 1 ~ "Advanced",
      TRUE ~ "unknown"
    ),
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  ) %>%
  select(Sex, Race, cancer_type, PatientAgeCapped, IsLate, StageOfCancer, PatientRace,
         TypeOfCancer, TypeOfEmergencyEvent, EP) %>%  # FIXME - delete this select() later?
  mutate()

colon <- all_data %>% filter(cancer_type == "Colon")
lung <- all_data %>% filter(cancer_type == "Lung")
```

# Colon

## Sex (n.s.)

```{r test-colon-sex}
tab_colon_sex <- table(colon$Sex, colon$IsLate)

fisher.test(tab_colon_sex)

chi_colon_sex <- chisq.test(tab_colon_sex)
chi_colon_sex
p_colon_sex <- chi_colon_sex$p.value
```

## Race (significant)

```{r test-colon-race}
tab_colon_race <- table(colon$Race, colon$IsLate)

fisher.test(tab_colon_race)

chi_colon_race <- chisq.test(tab_colon_race)
chi_colon_race
p_colon_race <- chi_colon_race$p.value
```

## Age (n.s.)

```{r plot-colon-age}
ggplot(data = colon, aes(
  PatientAgeCapped,
  fill = as.factor(IsLate),
  color = as.factor(IsLate)
  )) +
  geom_density(alpha=0.3)
```
```{r test-colon-age}
wilc_colon_age <- wilcox.test(
  colon %>% filter(IsLate == "Advanced") %>% pull(PatientAgeCapped),
  colon %>% filter(IsLate == "Early") %>% pull(PatientAgeCapped)
)

wilc_colon_age
p_colon_age <- wilc_colon_age$p.value
```




# Lung

## Sex (significant)

```{r test-lung-sex}
tab_lung_sex <- table(lung$Sex, lung$IsLate)

fisher.test(tab_lung_sex)

chi_lung_sex <- chisq.test(tab_lung_sex)
chi_lung_sex
p_lung_sex <- chi_lung_sex$p.value
```

## Race (significant)

```{r test-lung-race}
tab_lung_race <- table(lung$Race, lung$IsLate)

fisher.test(tab_lung_race, workspace = 2000000/4)

chi_lung_race <- chisq.test(tab_lung_race)
chi_lung_race
p_lung_race <- chi_lung_race$p.value
```

## Age (significant)

```{r plot-lung-age}
ggplot(
  data = lung,
  aes(
    PatientAgeCapped,
    fill = as.factor(IsLate),
    color = as.factor(IsLate)
  )
) +
  geom_density(alpha=0.3)
```

```{r test-lung-age}
wilc_lung_age <- wilcox.test(
  lung %>% filter(IsLate == "Advanced") %>% pull(PatientAgeCapped),
  lung %>% filter(IsLate == "Early") %>% pull(PatientAgeCapped)
)

wilc_lung_age
p_lung_age <- wilc_lung_age$p.value

t.test(
  lung %>% filter(IsLate == "Advanced") %>% pull(PatientAgeCapped),
  lung %>% filter(IsLate == "Early") %>% pull(PatientAgeCapped)
)
```




# Appendix: Detective work on race

```{r detective, message=FALSE, warning=FALSE}
all_data %>%
  group_by(cancer_type, Race, PatientRace) %>%
  summarise(count = n()) %>%
  arrange(cancer_type, PatientRace) %>%
  kable()
```




# Association tables

```{r categorical-assoc}
assoc_r <- all_data %>%
  count(cancer_type, IsLate, Race) %>%
  mutate(Factor = "Race") %>% 
  rename(Level = Race)

assoc_s <- all_data %>%
  count(cancer_type, IsLate, Sex) %>%
  mutate(Factor = "Sex") %>% 
  rename(Level = Sex)

assoc <- bind_rows(assoc_r, assoc_s) %>% 
  pivot_wider(names_from = c(cancer_type, IsLate), values_from = n) %>%
  mutate(
    Colon_Denom = Colon_Early + Colon_Advanced,
    Lung_Denom = Lung_Early + Lung_Advanced,
    Colon_Rate = round(Colon_Advanced / Colon_Denom * 100, 1),
    Lung_Rate = round(Lung_Advanced / Lung_Denom * 100, 1),
    p_colon = case_when(Factor == "Race" ~ round(p_colon_race, 3), TRUE ~ round(p_colon_sex, 3)),
    p_lung = case_when(Factor == "Race" ~ round(p_lung_race, 3), TRUE ~ round(p_lung_sex, 3))
  ) %>%
  select(
    Factor, Level,
    Colon_Advanced, Colon_Denom, Colon_Rate, p_colon,
    Lung_Advanced, Lung_Denom, Lung_Rate, p_lung
  )
```

```{r displayable}
assoc %>% 
  arrange(Factor, desc(Lung_Denom)) %>% 
  unite(Colon_Advanced, Colon_Denom, col="Colon_VA", sep = " / ") %>% 
  unite(Colon_VA, Colon_Rate, col="Colon_VA", sep=" (") %>% 
  unite(Lung_Advanced, Lung_Denom, col="Lung_VA", sep = " / ") %>% 
  unite(Lung_VA, Lung_Rate, col="Lung_VA", sep=" (") %>% 
  mutate(across(c(Colon_VA, Lung_VA), ~ paste0(.x, ")"))) %>%   # neat trick to add close paren
  kable()
```

```{r age-assoc}
q123 <- list(
  q1 = ~quantile(.x, 0.25, na.rm = TRUE),
  median = ~quantile(.x, 0.5, na.rm = TRUE),
  q3 = ~quantile(.x, 0.75, na.rm = TRUE),
  mean = ~round(mean(.x, na.rm=TRUE), 2),
  sd = ~round(sd(.x, na.rm = TRUE), 2)
)

all_data %>% 
  group_by(cancer_type, IsLate) %>% 
  summarise(across(PatientAgeCapped, q123)) %>% 
  unite(PatientAgeCapped_median, PatientAgeCapped_q1, col="Median_Q1", sep = " (") %>% 
  unite(Median_Q1, PatientAgeCapped_q3, col = "Median_Q1_Q3", sep = " - ") %>% 
  unite(PatientAgeCapped_mean, PatientAgeCapped_sd, col="Mean_SD", sep = " (") %>% 
  mutate(across(c(Median_Q1_Q3, Mean_SD), ~ paste0(.x, ")"))) %>% 
  mutate(P_value = case_when(
    cancer_type == "Colon" ~ round(p_colon_age, 3),
    TRUE ~ p_lung_age
  )) %>% 
  kable()
```

FIXME - probably widen this out with col names like `Colon_VA`.




# For later

Package `Hmisc` and function `binconf()` ?

```{r ci-example, echo=TRUE}
X <- data.frame(succ = c(52,76,64,68), denom=c(90,100,96,100))

X %>% mutate(
  ciw.poi = binconf(succ, denom)[,"PointEst"],
  ciw.low = binconf(succ, denom)[,"Lower"],
  ciw.upp = binconf(succ, denom)[,"Upper"],
  
  cia.poi = binconf(succ, denom, method = "asymptotic")[,"PointEst"],
  cia.low = binconf(succ, denom, method = "asymptotic")[,"Lower"],
  cia.upp = binconf(succ, denom, method = "asymptotic")[,"Upper"],
) %>%
  mutate(across(starts_with("ci"), ~ round(.x * 100, 1) )) %>% 

  unite(ciw.poi, ciw.low, col="Proportion_Wilson_CI", sep = " (") %>% 
  unite(Proportion_Wilson_CI, ciw.upp, col = "Proportion_Wilson_CI", sep = " - ") %>% 
  unite(cia.poi, cia.low, col="Proportion_Wald_CI", sep = " (") %>% 
  unite(Proportion_Wald_CI, cia.upp, col = "Proportion_Wald_CI", sep = " - ") %>% 
  mutate(across(
    c(Proportion_Wilson_CI, Proportion_Wald_CI),
    ~ paste0(.x, ")")   # neat trick to add close paren
  )) %>%
  kable()
```




# To Do

- [ ] Descriptive stats (large scale)
    - flow diagram
    - missingness
    - demographics (by health sys)
- [ ] Manual review stats
    - description of temporal distribution
    - temporal vs demographic
    - temporal vs MOD
    - CIs for percent of MOD
- [ ] Geis data
