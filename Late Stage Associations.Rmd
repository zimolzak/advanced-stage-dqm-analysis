---
title: "Late Stage Associations"
author: "Andrew Zimolzak, MD, MMSc"
date: "`r Sys.Date()`"
#output: pdf_document
output: word_document
---

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(knitr)
library(tidyr)
library(Hmisc)
library(forcats)
library(stringr)
# consider later: clean_names() from {janitor} 

knitr::opts_chunk$set(echo = FALSE)  # Sets the default to "Run but don't show code."
```

```{r import, include=FALSE}
# Comprehensive

lung_raw <- read_csv("VA Lung comprehensive.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Lung", site="VA")

colon_raw <- read_csv("VA Colon comprehensive.csv", show_col_types = FALSE) %>%
  mutate(cancer_type = "Colon", site="VA")

geisinger_comprehensive <- tribble(
  ~site, ~cancer_type, ~n, ~Stage,
  "Geisinger", "Lung", 1699, "Advanced",
  "Geisinger", "Lung", 2914, "Total",
  "Geisinger", "Colon", 227, "Advanced",
  "Geisinger", "Colon", 627, "Total",
)

# Chart review

geis_columns <- read_csv("geis_colnames.csv", show_col_types = FALSE)
coltype_spec <- paste0(geis_columns$type, collapse="")
# The colnames CSV is only for lung.
lung_geis_raw <- read_csv("final lung LS for Houston de-id Divvy 3-28-22.csv",
                          col_types = coltype_spec,
                          show_col_types = FALSE)  # mutate *after* assigning column names.

colon_geis_raw <- read_csv("Late Stage CRC Final DU 1-26-22.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Colon", site="Geisinger")

lung_va_raw <- read_csv("deid-again-2025-01/deid+MM3_LC_Export_Added1OfMissing3.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Lung", site="VA")

colon_va_raw <- read_csv("deid-again-2025-01/deid+MM3_CRC_Export.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Colon", site="VA") %>% 
  filter(!is.na(CancerStage)) %>%  # filter garbage rows at end (leftover of Excel)
  rename(siginit = `siginit-neg-never`)
```

```{r tidy-comprehensive}
all_data <- bind_rows(colon_raw, lung_raw) %>%
  mutate(
    Sex = case_when(PatientSex == 1 ~ "M",TRUE ~ "F"),
    Stage = as.factor(case_when(
      IsLate == 0 ~ "Early",
      IsLate == 1 ~ "Advanced",
      TRUE ~ "unknown"
    )),
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  ) %>%
  rename(
    StageGroupNumeric = StageOfCancer,
    Age = PatientAgeCapped
  ) %>% 
  relocate(site, cancer_type, Sex, Race, Age, Stage)

rm(colon_raw, lung_raw)  # keep geisinger_comprehensive for later
```

```{r tidy-chart-reviews, message=FALSE}
colnames(lung_geis_raw) <- geis_columns$name

yr_offset <- 365.25 * (2016 - 1970)  # to generate fake VA dates

reviewed_geis_lung <- lung_geis_raw %>%
  mutate(
    cancer_type = "Lung",
    site="Geisinger",
    MOD_definite = case_when(
      MOD_present_main_outcome == "Yes" ~ TRUE,
      MOD_present_main_outcome == "No" ~ FALSE,
      MOD_present_main_outcome == "Unsure" ~ FALSE,
      TRUE ~ NA
    )
  ) %>% 
  rename(
    Sex = Gender,
    screening_offered = ldct_offered,
    screening_declined = ldct_declined
  ) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race,  # Location,
    signal_present, cancer_dx_considered, MOD_present_main_outcome, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type
  )

reviewed_geis_colon <- colon_geis_raw %>% 
  rename(
    Age = `Age:`,
    modtext = `Is there a missed opportunity (in general) in this case?`,
    screening_declined = `Did the patient decline screening colonoscopies in the past?`,
    screening_performed = `Was a colonoscopy screening performed prior to index visit?`
  ) %>% 
  mutate(
    Sex = as.factor(`Gender:`),
    Race = as.factor(case_when(
      `Ethnicity:` == "HISPANIC OR LATINO" ~ "Hispanic or Latino",
      TRUE ~ `Race:`
    )),
    Location = as.factor(`Location:`),
    signal_present = as.factor(
      `Prior to index presentation, were there any cancer signals (important/relevant findings)?`
    ),
    MOD_definite = case_when(
      modtext == "Yes" ~ TRUE,
      modtext == "No" ~ FALSE,
      modtext == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    cancer_dx_considered = as.factor(`Was a cancer diagnosis considered at the time of the earliest cancer signal?`),
    signal_date = as.Date(`When was it recorded?`),
    dx_eval_init_date = as.Date(`When was cancer-related diagnostic evaluation initiated?`),
    dx_eval_complete_date = as.Date(`When was the evaluation completed?`),
    signal_type = as.factor(`What was the earliest cancer signal recorded?`),
    .keep = "unused"
  ) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date
  )

reviewed_va_lung_colon <- lung_va_raw %>% 
  bind_rows(colon_va_raw) %>% 
  mutate(
    siginit = case_when(
      siginit < -40000 ~ NA,
      .default = siginit
    ),
    initcomp = case_when(
      initcomp < -40000 ~ NA,
      .default = initcomp
    ),
    signal_present = as.factor(RFYesNo),
    cancer_dx_considered = as.factor(RFInitialCancerDxConsidered),
    MOD_definite = case_when(
      DxMOD == "Yes" ~ TRUE,
      DxMOD == "No" ~ FALSE,
      DxMOD == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    signal_date = as.Date(yr_offset),
    dx_eval_init_date = as.Date(siginit + yr_offset),
    dx_eval_complete_date = as.Date(siginit + initcomp + yr_offset),
    signal_type = as.factor(RFInitialRF)
  ) %>% 
  rename(screening_declined = PtDecline) %>% 
  relocate(
    site, cancer_type,  # Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type,
    siginit, initcomp
  )

# IMPORTANT list of kept variables below.

reviewed_all <- bind_rows(
    reviewed_geis_colon, reviewed_geis_lung, reviewed_va_lung_colon
  ) %>% 
  select(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date,
    Reviewer,
    screening_performed, screening_declined, screening_offered
  ) %>% 
  mutate(
    across(c(site, cancer_type), as.factor),
    Sex = fct_collapse(Sex, M = "MALE", F = "FEMALE"),
    
    # NOTE the different naming "signal" vs "sig", and "completion" vs "complete"
    
    signal_to_init = as.numeric(dx_eval_init_date - signal_date),
    init_to_completion = as.numeric(dx_eval_complete_date - dx_eval_init_date),
    signal_to_completion = as.numeric(dx_eval_complete_date - signal_date)
  )
```

```{r remove-chart-rev-bits}
rm(lung_va_raw, colon_va_raw, lung_geis_raw, colon_geis_raw)
rm(coltype_spec, geis_columns)
rm(reviewed_geis_colon, reviewed_geis_lung, reviewed_va_lung_colon)
```




# Preliminary descriptive results

```{r definitions}
percentage_text <- function(numerator, denominator, print_denom = TRUE) {
  # It appears to be already vectorized.
  ntext <- as.character(numerator)
  dtext <- as.character(denominator)
  ptext <- as.character(round(numerator / denominator * 100, 1))
  if (print_denom) {
    final_text <- paste0(ntext, " / ", dtext, " (", ptext, "%)")
  }
  else {
    final_text <- paste0(ntext, " (", ptext, "%)")
  }
  return(final_text)
}

pct_ci_text <- function(numerator, denominator) {
  low = binconf(numerator, denominator)[,"Lower"]
  upp = binconf(numerator, denominator)[,"Upper"]
  ptext <- as.character(round(numerator / denominator * 100, 1))
  ltext <- as.character(round(low * 100, 1))
  utext <- as.character(round(upp * 100, 1))
      
  final_text <- paste0(ptext, "% (", ltext, "-", utext, ")")
  return(final_text)
}

q123ms <- list(
  q1 = ~quantile(.x, 0.25, na.rm = TRUE),
  median = ~quantile(.x, 0.5, na.rm = TRUE),
  q3 = ~quantile(.x, 0.75, na.rm = TRUE),
  mean = ~round(mean(.x, na.rm=TRUE), 2),
  sd = ~round(sd(.x, na.rm = TRUE), 2)
)
```

```{r prep-categor-subtables, message=FALSE}
compr_n <- all_data %>%
  group_by(site, cancer_type) %>% 
  count() %>% 
  bind_rows(geisinger_comprehensive %>% filter(Stage=="Total") %>% select(site, cancer_type, n)) %>% 
  mutate(n = as.character(n)) %>% 
  pivot_wider(names_from = cancer_type, values_from = n) %>% 
  mutate(Characteristic = "n", Level="n")

compr_sex <- all_data %>%
  group_by(site, cancer_type) %>% 
  count(Sex) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent = percentage_text(n, d, FALSE), .keep = "unused") %>% 
  filter(Sex == "M") %>% 
  pivot_wider(names_from = cancer_type, values_from = Percent) %>% 
  mutate(Characteristic = "Sex") %>% 
  rename(Level = Sex)

compr_race <- all_data %>%
  group_by(site, cancer_type) %>% 
  count(Race) %>% 
  mutate(d = sum(n)) %>% 
  arrange(desc(cancer_type), desc(n)) %>% 
  mutate(Percent = percentage_text(n, d, FALSE), .keep = "unused") %>% 
  pivot_wider(names_from = cancer_type, values_from = Percent) %>% 
  mutate(Characteristic = "Race") %>% 
  rename(Level = Race)

compr_age <- all_data %>%
  group_by(site, cancer_type) %>% 
  summarise(across(Age, q123ms)) %>% 
  unite(col = quartiles, c(Age_median, Age_q1), sep = " (") %>% 
  unite(col = quartiles, c(quartiles, Age_q3), sep = " - ") %>% 
  mutate(quartiles = paste0(quartiles, ")")) %>% 
  select(site, cancer_type, quartiles) %>% 
  pivot_wider(names_from = cancer_type, values_from = quartiles) %>% 
  mutate(Characteristic = "Age", Level="Age")

compr_adv <- rbind(  # FIXME_maybe - should we use bind_rows() ?
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count() %>%
    mutate(Stage = "Total"),  # denominator, basically
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count(Stage)  # numerators Advanced & Early
) %>%
  filter(Stage != "Early") %>%  # just 1 numerator
  bind_rows(geisinger_comprehensive) %>% 
  arrange(desc(site), desc(cancer_type), Stage) %>% 
  pivot_wider(names_from = c(site, cancer_type, Stage), values_from = n) %>% 
  mutate(
    VA_Lung = percentage_text(VA_Lung_Advanced, VA_Lung_Total),  # Not doing the ", FALSE)" thing, just as a double check.
    VA_Colon = percentage_text(VA_Colon_Advanced, VA_Colon_Total),
    Geisinger_Lung = percentage_text(Geisinger_Lung_Advanced, Geisinger_Lung_Total),
    Geisinger_Colon = percentage_text(Geisinger_Colon_Advanced, Geisinger_Colon_Total),
    Characteristic = "Advanced stage",
    Level = "Advanced stage",
    .keep = "unused"
  )
```

```{r table-1-descr-comprehensive}
table_1_for_later <- bind_rows(compr_n, compr_sex, compr_race, compr_age) %>% 
  ungroup() %>% 
  pivot_wider(names_from = site, values_from = c(Colon, Lung), names_glue = "{site}_{.value}") %>% 
  bind_rows(compr_adv) %>% 
  mutate(
    Characteristic = Level,  # A tricky rename: don't get confused later if debugging.
    `VA Lung` = VA_Lung,
    `VA Colon` = VA_Colon,
    `Geisinger Lung` = Geisinger_Lung,
    `Geisinger Colon` = Geisinger_Colon,
    .keep = "unused"
  )
```

```{r cleanup-after-t1}
rm(compr_n, compr_adv, compr_age, compr_race, compr_sex)
```

```{r plot-age-simple, eval=FALSE, include=FALSE}
all_data %>% 
  ggplot(aes(x=Age)) +
  geom_histogram(binwidth = 2) +
  facet_grid(rows=vars(cancer_type))
```

## For editor comment (PCP visit criterion/flow)

```{r pcp-stats, message=FALSE}
all_data %>%
  group_by(site, cancer_type) %>%
  summarise(
    pts=n(), pcp1=sum(HasPCPBeforeCutOff) ,pcp2=sum(HasPCPAfterCutOff),
    percent_before_cutoff=percentage_text(pcp1, pts),
    percent_after_cutoff=percentage_text(pcp2, pts)
  ) %>% 
  select(site, cancer_type, percent_before_cutoff, percent_after_cutoff) %>% 
  kable()

all_data %>% 
  count(site, cancer_type, HasPCPAfterCutOff, HasPCPBeforeCutOff) %>% 
  kable()
```

Interpretation of this last table: The combination of no PCP after cutoff
**and** no PCP before cutoff (the pair (0,0)) doesn't exist. Only (0,1), (1,0),
and (1,1) exist. Seems like we did inclusion criterion where it must be (before
**or** after). Or it's just that everyone has a PCP visit at some point.

## For R1 comment (missingness)

> How did the authors deal with unknown/incomplete stage cases in cohort construction and calculation of the % advanced stage?

```{r stage-missingness-fancy, message=FALSE}
all_data %>%
  group_by(site, cancer_type, StageGroupNumeric) %>% 
  summarise(n = n(), n_missing = sum(is.na(StageGroupNumeric))) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent.at.stage = percentage_text(n, d), .keep = "unused") %>% 
  relocate(site, cancer_type, StageGroupNumeric, Percent.at.stage, n_missing) %>% 
  kable()
```

## Proportions table (*very* detailed)

```{r generate-table-ci}
va_population_ci <- all_data %>%
  group_by(site, cancer_type) %>% 
  count(Sex) %>% 
  mutate(d = sum(n)) %>% 
  mutate(
    Fact = "Sex",
    Val = Sex,
    .keep = "unused"
  )

chart_rev_confint <- bind_rows(
  # Build up "sub-tables," one for each of 4 categorical vars of interest.
  # (MOD, sex, signal, considered)
  # Each sub-table is like:
  # site, cancer_type, Fact, Val, n, d
  # VA,   Colon,       Sex,  F,   55, 100.
  
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, MOD_definite) %>% filter(!is.na(MOD_definite)) %>%
    mutate(d = sum(n), Fact = "MOD", Val=as.character(MOD_definite)) %>% 
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, Sex) %>% filter(!is.na(Sex)) %>%
    mutate(d = sum(n), Fact = "Sex", Val=as.character(Sex)) %>% 
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, signal_present) %>% filter(!is.na(signal_present)) %>%
    mutate(d = sum(n), Fact = "Ca signal", Val=as.character(signal_present)) %>% 
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    filter(!is.na(cancer_dx_considered)) %>% count(site, cancer_type, cancer_dx_considered) %>%
    mutate(d = sum(n), Fact = "Ca considered", Val=as.character(cancer_dx_considered)) %>%  
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, screening_declined) %>%
    mutate(d = sum(n), Fact = "Ever declined screening", Val=as.character(screening_declined)) %>%  
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, Race) %>%
    mutate(d = sum(n), Fact = "Race", Val=as.character(Race)) %>%  
    select(site, cancer_type, Fact, Val, n, d),
  va_population_ci
) %>% 
  mutate(
    Percentage = percentage_text(n, d),
    P_CI_short = pct_ci_text(n, d),
    wilson.poi = binconf(n, d)[,"PointEst"],
    wilson.low = binconf(n, d)[,"Lower"],
    wilson.upp = binconf(n, d)[,"Upper"]
  ) %>% 
  filter(
    # Exclude a few rows because it is redundant to say 25% true, 75% false. Just
    # mention one of these %s.
    (Fact == "MOD" & Val == TRUE) |
      (Fact == "Sex" & Val == "M") |
      (Fact == "Ca signal" & Val == "Yes") |  # Assume NA = no signal.
      (Fact == "Ca considered" & Val == "No") |  # Assume Unsure = considered.
      (Fact == "Ever declined screening" & Val == "Yes") |
      Fact == "Race"
  ) %>% 
  unite(col=Characteristic, Fact, Val, sep=" ") %>%
  mutate(Characteristic = case_when(
    Characteristic == "Ca considered No" ~ "Cancer not considered",
    Characteristic == "Ca signal Yes" ~ "Cancer signal present",
    Characteristic == "Ever declined screening Yes" ~ 'Declined screening',
    Characteristic == "MOD TRUE" ~ 'MOD present',
    Characteristic == "Sex M" ~ 'Male',
    .default = Characteristic
  )) %>% 
  arrange(desc(site), desc(cancer_type), Characteristic)
```

```{r kable-descr-reviews}
# Print the detailed CI table now.
chart_rev_confint %>%
  select(site, cancer_type, Characteristic, Percentage, wilson.low, wilson.upp) %>% 
  mutate(across(starts_with("wilson"), ~ round(.x * 100, 1) )) %>% 
  unite(wilson.low, wilson.upp, col="Wilson_CI", sep = "-") %>% 
  unite(col=Percent_CI, Percentage, Wilson_CI, sep = " ") %>% 
  pivot_wider(names_from = c(site, cancer_type), values_from = Percent_CI) %>% 
  kable()

# Prepare concise CI table for later. We do bind_rows() on it later: "TABLE 1"
review_ci_concise <- chart_rev_confint %>%
  select(site, cancer_type, Characteristic, P_CI_short) %>% 
  pivot_wider(names_from = c(site, cancer_type), values_from = P_CI_short, names_sep = " ") %>% 
  mutate(Characteristic = case_when(
    Characteristic == "Race WHITE" ~ "White",
    Characteristic == "Race BLACK OR AFRICAN AMERICAN" ~ "Black",
    Characteristic == "Race ASIAN" ~ "Other",
    Characteristic == "Race Hispanic or Latino" ~ "Hispanic",
    .default = Characteristic
  )) %>% 
  filter(Characteristic != "Race NA")
```

## Proportions plot

```{r plot-ci}
theme_set(theme_bw())

chart_rev_confint %>% 
  filter(!grepl("Race", Characteristic)) %>%   # FIXME - can bring back later
  rename(Site = site) %>% 
  ggplot(aes(x = Characteristic, y = wilson.poi, colour = Site, group = Site)) +
  facet_grid(cols=vars(cancer_type)) +
  geom_errorbar(aes(ymin = wilson.low, ymax = wilson.upp), position = "dodge", width=0.3, color="#222222", linewidth = 0.3) +
  geom_point(position= position_dodge(width = 0.3)) +
  scale_x_discrete(
    guide = guide_axis(n.dodge = 3),
    # labels = c("Cancer not\nconsidered", 'Cancer signal\npresent', 'Declined\nscreening', 'MOD present', 'Male')
  ) +
  ylim(0,1) +
  labs(x = "Patient Characteristic", y = "Proportion of Patients") +
  theme(
    panel.grid.major.x = element_blank(),
    legend.title =  element_text(size=10),
    legend.position = "inside",
    legend.background  = element_rect(color="grey", linewidth = 0.4),
    legend.position.inside = c(0.1, 0.92)
  )
```

\newpage




# TABLE 1 

```{r functions-continuous-vars}
median_text_scalar <- function(m, q1, q3){
  vec <- c(
    as.character(round(m, 1)),
    " (",
    as.character(round(q1, 1)),
    " - ",
    as.character(round(q3, 1)),
    ")"
  )
  return(paste0(vec, collapse = ""))
}

mean_text_scalar <- function(m, s){
  vec <- c(
    as.character(round(m, 1)),
    " (",
    as.character(round(s, 1)),
    ")"
  )
  return(paste0(vec, collapse = ""))
}

median_text <- Vectorize(median_text_scalar)
mean_text <- Vectorize(mean_text_scalar)
```

```{r kable-descriptives-allvars-strat, message=FALSE}
t1_df <- data.frame(
  Characteristic_short = c(
    "Age",
    "signal_to_init",
    "signal_to_completion",
    "init_to_completion",
    "Cancer not considered",
    "Cancer signal present",
    "Declined screening",
    "MOD present",
    "Male",
    "Advanced stage",
    "White",
    "Black",
    "Hispanic",
    "Other",
    "n"
  ),
  order = c(1, 7, 9, 8, 5, 3, 6, 4, 2, 2.5, 2.1, 2.15, 2.2, 2.3, 0),
  Characteristic = c(
    "Age, y",
    "Cancer signal to workup initiation, d",
    "Cancer signal to workup completion, d",
    "Workup initiation to completion, d",
    "Cancer not considered",
    "Cancer signal present",
    "Declined screening",
    "MOD present",
    "Male",
    "Advanced stage",
    "White",
    "Black",
    "Hispanic",
    "Other",
    "n"
  )
)

t1t2 <- reviewed_all %>% 

  # Do statistics on CONTINUOUS variables.
  group_by(site, cancer_type) %>% 
  summarise(across(c(Age, signal_to_init, init_to_completion, signal_to_completion), q123ms)) %>% 
  pivot_longer(
    cols = starts_with(c("Age", "signal", "init")),
    names_to = c("variable", "statistic"),
    names_pattern = "(.*)_(.*)"
  ) %>%
  filter(statistic!="mean", statistic!="sd") %>% 
  pivot_wider(names_from = statistic, values_from = value) %>% 
  mutate(
    median_q1_q3 = median_text(median, q1, q3),
    .keep = "unused"
  ) %>% 
  pivot_wider(
    names_from = c(site, cancer_type),
    values_from = median_q1_q3,
    names_sep = " "
  ) %>% 
  rename(Characteristic_short = variable) %>%
  
  # Bring in stats on DISCRETE variables.
  # IMPORTANT - this is where review_ci_concise comes in.
  bind_rows(review_ci_concise %>% rename(Characteristic_short = Characteristic)) %>% 
  right_join(t1_df) %>%  # note, this has similar effect to filter. If row now mentioned, not included.
  arrange(order) %>% 
  select(order, Characteristic, `VA Lung`, `VA Colon`, `Geisinger Lung`, `Geisinger Colon`)

table_1_for_later %>% 
  mutate(Characteristic = case_when(
    Characteristic == "M" ~ "Male",
    Characteristic == "Age" ~ "Age, y",
    .default = Characteristic
  )) %>% 
  left_join(
    t1t2 %>% 
    filter(order < 3, Characteristic != "Advanced stage") %>% 
    select(order, Characteristic, `Geisinger Lung`, `Geisinger Colon`) %>%   # age, male
    rename(gl = `Geisinger Lung`, gc = `Geisinger Colon`)
  ) %>% 
  arrange(order) %>% 
  # Fix the NAs
  mutate(
    `Geisinger Lung` = case_when(
      is.na(`Geisinger Lung`) ~ gl,
      .default = `Geisinger Lung`
    ),
    `Geisinger Colon` = case_when(
      is.na(`Geisinger Colon`) ~ gc,
      .default = `Geisinger Colon`
    )
  ) %>% 
  select(Characteristic, `VA Lung`, `VA Colon`, `Geisinger Lung`, `Geisinger Colon`) %>% 
  replace_na(list(`Geisinger Lung` = "0%")) %>% 
  kable()
```

# TABLE 2

Between the two of these tables, they should have everything that's in the proportions plot.

```{r table2}
t1t2 %>% 
  filter(order >= 3 ) %>% 
  select(Characteristic, `VA Lung`, `VA Colon`, `Geisinger Lung`, `Geisinger Colon`) %>% 
  kable()
```

## Age descriptive boxplot

- *Turned off.*

```{r age-definitive, eval=FALSE, warning=FALSE, include=FALSE}
temp_boxplot_data <- reviewed_all %>%
  filter(site == "Geisinger") %>% 
  select(site, cancer_type, Age) %>% 
  bind_rows(
    all_data %>%
      select(site, cancer_type, Age)
  ) %>%
  group_by(site, cancer_type) %>% 
  mutate(
    is_outlier = case_when(
      Age < quantile(Age, probs = 0.25) - 1.5 * IQR(Age) ~ "black",
      Age > quantile(Age, probs = 0.75) + 1.5 * IQR(Age) ~ "black",
      TRUE ~ NA
    )
  )

temp_boxplot_data %>% 
  ggplot(aes(y=Age, x  = paste(site, cancer_type), fill=site )) +
  geom_boxplot(staplewidth = 0.2, outlier.shape = NA) +
  geom_jitter(color = temp_boxplot_data$is_outlier, shape = 1, alpha = 0.6, width = 0.25 ) +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "none"
  ) +
  labs(x = "") +
  scale_fill_hue(c=50)
```

## Temporality figures and table

```{r constants}
yearly = seq(0, 6000, 365)
monthly = seq(0, 6000, 365/12)
quarterly = seq(0, 6000, 365/4)
THREE_MONTHS = 365 / 4

year_breaks_custom <- c(c(0, 0.25, 0.5), seq(1, 17, 1))
day_breaks_custom <- year_breaks_custom * 365
```

What we want:

> temporal distribution of MODs, with regard to diagnosis (i.e. how many occurred <3 months prior to appropriate evaluation/diagnosis, vs 3–6 months, 6–12 mos, etc)....

```{r constants-ed}
year_breaks_ed <- c(0, 0.25, 0.5, 1, 2, 3 ,4, 20)
month_breaks_ed <- year_breaks_ed * 12
day_breaks_ed <- year_breaks_ed * 365
```

- Turned off: two boxplots (stratified on $x$ axis) of $t_{13}$ and $t_{23}$. They are just
subsets of the $3 \times 4$ boxplot (Figure 1) that is to follow.

```{r boxplot-s2c, eval=FALSE, include=FALSE}
reviewed_all %>% 
  filter(MOD_definite == TRUE, signal_to_completion >= 0) %>% 
  mutate(
    signal_to_completion_yrs = signal_to_completion/365.25,
    Population = paste(site, cancer_type)
  ) %>% 
ggplot(aes(y=signal_to_completion_yrs, x = Population, fill=site)) +
  geom_boxplot(staplewidth = 0.15) +
  coord_cartesian(ylim=c(0, 4)) +
  scale_y_continuous(minor_breaks = seq(1,20)) +
  labs(title="Limited to MOD only") +
  theme(panel.grid.major.x = element_blank(), legend.position = "none") +
  scale_fill_hue(c=50)

reviewed_all %>% 
  filter(MOD_definite == TRUE, init_to_completion >= 0) %>% 
  mutate(
    init_to_completion_yrs = init_to_completion/365.25,
    Population = paste(site, cancer_type)
  ) %>% 
ggplot(aes(y=init_to_completion_yrs, x = Population, fill=site)) +
  geom_boxplot(staplewidth = 0.15) +
  coord_cartesian(ylim=c(0, 1.5)) +
  scale_y_continuous(minor_breaks = seq(1, 20)) +
  labs(title="Limited to MOD only") +
  theme(panel.grid.major.x = element_blank(), legend.position = "none") +
  scale_fill_hue(c=50)
```

# FIGURE 1: MOD SEVERITY. INCLUDE. Limited to MOD only

```{r multi-box-MOD-severity, message=FALSE}
temp_mod_sv <- reviewed_all %>% 
  mutate(
    across(contains("_to_"), ~ .x/365.25),
    Population_n = paste(site, cancer_type, sep="\n"),
    Population_s = paste(site, cancer_type, sep=" ")   # in case we want to flip coords later
  ) %>% 
  rename(
    `Time 1\n(signal to workup initiation)` = signal_to_init,
    `Time 2\n(initiation to completion)` = init_to_completion,
    `Total (Time 1 + Time 2)` = signal_to_completion,
  ) %>% 
  pivot_longer(cols = contains("(")) %>% 
  filter(
    MOD_definite == TRUE, 
    value >= 0
  ) 

Y_MAX <- 6  # 8 almost okay but boring

fig1 <- temp_mod_sv %>% 
  mutate(Population = Population_n) %>% 
ggplot(aes(y = value, x = Population, fill=site)) +
  geom_boxplot(staplewidth = 0.15, outlier.shape = 1, outlier.alpha = 0.7) +
  coord_cartesian(ylim = c(0, Y_MAX)) +
  facet_grid(cols = vars(name)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  labs(y = "Time, y") +
  theme(panel.grid.major.x = element_blank(), legend.position = "none") +
  scale_fill_hue(c=50)

fig1

ggsave("fig1.png", width = 6.5, height=7)
```

## About off-scale points

```{r some-off-scale-counts, message=FALSE}
temp_mod_sv %>% 
  filter(value > Y_MAX) %>% 
  select(site, cancer_type, name, value) %>% 
  group_by(name, site, cancer_type) %>% 
  summarise(n = n(), max = round(max(value), 1)) %>% 
  group_by(name) %>% 
  mutate(
    subtot = sum(n),
    name = str_replace(name, "\n", " ")
    ) %>% 
  kable()

cuts <- temp_mod_sv %>% 
  # filter(value > Y_MAX) %>% 
  select(site, cancer_type, name, value) %>% 
  group_by(name) %>% 
  summarise(
    n_cut_off = sum(value > Y_MAX),
    max = round(max(value), 1),
    total = n()
  )

cuts %>% 
  mutate(name = str_replace(name, "\n", " ")) %>% 
  kable()
```

**For figure legend:**

In panel one, `r cuts[1,2]` of `r cuts[1,4]` points are off scale, with a maximum of `r cuts[1,3]`.
In panel two, `r cuts[2,2]` of `r cuts[2,4]` points are off scale, with a maximum of `r cuts[2,3]`.
In panel three, `r cuts[3,2]` of `r cuts[3,4]` points are off scale, with a maximum of `r cuts[3,3]`.

## Table with bins

```{r table-binning}
reviewed_all %>% 
  filter(MOD_definite == TRUE) %>% 
  mutate(
    months = signal_to_completion /  (365 / 12),
    signal_to_completion_months = cut(months, breaks=month_breaks_ed),
    .before = everything()
  ) %>% 
  group_by(site, cancer_type) %>% 
  count(signal_to_completion_months, .drop = FALSE) %>% 
  mutate(s = sum(n), Percent = percentage_text(n, s), .before = everything()) %>% 
  select(site, cancer_type, Percent, signal_to_completion_months) %>% 
  pivot_wider(id_cols = signal_to_completion_months, names_from = c(site, cancer_type), values_from = Percent) %>% 
  kable()
```




# TABLE 3? Race and sex $\sim$ advanced

```{r construct-pvals}
colon <- all_data %>% filter(cancer_type == "Colon")
lung <- all_data %>% filter(cancer_type == "Lung")

tab_colon_sex <- table(colon$Sex, colon$Stage)
chi_colon_sex <- chisq.test(tab_colon_sex)
p_colon_sex <- chi_colon_sex$p.value

tab_colon_race <- table(colon$Race, colon$Stage)
chi_colon_race <- chisq.test(tab_colon_race)
p_colon_race <- chi_colon_race$p.value

tab_lung_sex <- table(lung$Sex, lung$Stage)
chi_lung_sex <- chisq.test(tab_lung_sex)
p_lung_sex <- chi_lung_sex$p.value

tab_lung_race <- table(lung$Race, lung$Stage)
chi_lung_race <- chisq.test(tab_lung_race)
p_lung_race <- chi_lung_race$p.value

wilc_colon_age <- wilcox.test(
  colon %>% filter(Stage == "Advanced") %>% pull(Age),
  colon %>% filter(Stage == "Early") %>% pull(Age)
)
p_colon_age <- wilc_colon_age$p.value

wilc_lung_age <- wilcox.test(
  lung %>% filter(Stage == "Advanced") %>% pull(Age),
  lung %>% filter(Stage == "Early") %>% pull(Age)
)
p_lung_age <- wilc_lung_age$p.value

rm(chi_colon_race, chi_colon_sex, chi_lung_race, chi_lung_sex)
rm(tab_colon_race, tab_colon_sex, tab_lung_race, tab_lung_sex)
```

The following table might be useful if it helps explain what's going on and why I
mentioned only 2 levels of race as a factor in the text.

All $P$ values are by $\chi^2$.

```{r categorical-assoc}
assoc_r <- all_data %>%
  count(cancer_type, Stage, Race) %>%
  mutate(Factor = "Race") %>% 
  rename(Level = Race)

assoc_s <- all_data %>%
  count(cancer_type, Stage, Sex) %>%
  mutate(Factor = "Sex") %>% 
  rename(Level = Sex)

assoc <- bind_rows(assoc_r, assoc_s) %>% 
  pivot_wider(names_from = c(cancer_type, Stage), values_from = n) %>%
  mutate(
    Colon_Denom = Colon_Early + Colon_Advanced,
    Lung_Denom = Lung_Early + Lung_Advanced,
    Colon_Rate = round(Colon_Advanced / Colon_Denom * 100, 1),
    Lung_Rate = round(Lung_Advanced / Lung_Denom * 100, 1),
    p_colon = case_when(Factor == "Race" ~ round(p_colon_race, 3), Factor == "Sex" ~ round(p_colon_sex, 3)),
    p_lung = case_when(Factor == "Race" ~ round(p_lung_race, 3), Factor == "Sex" ~ round(p_lung_sex, 3))
  ) %>%
  select(
    Factor, Level,
    Colon_Advanced, Colon_Denom, Colon_Rate, p_colon,
    Lung_Advanced, Lung_Denom, Lung_Rate, p_lung
  )

rm(assoc_r, assoc_s)

assoc %>% 
  arrange(Factor, desc(Lung_Denom)) %>% 
  unite(Colon_Advanced, Colon_Denom, col="Colon_VA", sep = " / ") %>% 
  unite(Colon_VA, Colon_Rate, col="Colon_VA_advanced", sep=" (") %>% 
  unite(Lung_Advanced, Lung_Denom, col="Lung_VA", sep = " / ") %>% 
  unite(Lung_VA, Lung_Rate, col="Lung_VA_advanced", sep=" (") %>% 
  mutate(across(c(Colon_VA_advanced, Lung_VA_advanced), ~ paste0(.x, ")"))) %>%
  # neat trick to add close paren
  kable()
```

**End of the important outputs.**

\newpage




# APPENDIX: misc.\ results

The rest of these analyses are just not very illuminating

## Age vs.\ advanced

- *Turned off:* $2 \times 2$ facet and colored density plot. Allows us to see the barely
different age peaks. And the little shoulder from colon cancer screening.

```{r plot-age-facetted, eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE}
ggplot(all_data, aes(Age, fill=Stage, color=Stage)) +
  geom_density(alpha=0.3) +
  facet_grid(rows=vars(cancer_type)  ) +
  xlim(20, 100)
```

All $P$ values are by Wilcoxon.

```{r age-assoc, message=FALSE}
all_data %>% 
  group_by(cancer_type, Stage) %>% 
  summarise(across(Age, q123ms), n=n()) %>% 
  unite(Age_median, Age_q1, col="Median_Q1", sep = " (") %>% 
  unite(Median_Q1, Age_q3, col = "Age_quartiles", sep = " - ") %>% 
  unite(Age_mean, Age_sd, col="Age_mean_SD", sep = " (") %>% 
  mutate(across(starts_with("Age_"), ~ paste0(.x, ")"))) %>% 
  mutate(P_value = case_when(
    cancer_type == "Colon" ~ round(p_colon_age, 3),
    TRUE ~ p_lung_age  # Trying to show very low P without rounding.
  )) %>% 
  select(cancer_type, Stage, n, Age_mean_SD, P_value) %>%   
  # drops Age_quartiles because it wasn't very informative
  kable()
```

```{r text-prep}
mean_ages_lung <- all_data %>% 
  filter(cancer_type=="Lung") %>% 
  group_by(Stage) %>% 
  summarise(m=mean(Age)) %>% 
  arrange(Stage)

r2 <- function(n) {
  d <- 2
  r <- round(n, d)
  f <- format(r, nsmall = d)
  return(f)
}

mala <- mean_ages_lung[1,] %>% pull(m)
mall <- mean_ages_lung[2,] %>% pull(m)
maldiff <- abs(mala - mall)
```

No difference in age between colon advanced and colon early. Lung advanced skews slightly earlier than lung early (`r r2(mala)` vs. `r r2(mall)` years, difference of `r r2(maldiff)`).

## Time vs. gender

$P$ values here are by Wilcoxon.

```{r good-wilcox, message=FALSE, warning=FALSE}
reviewed_all %>%
  group_by(site, cancer_type) %>%
  filter(!is.na(signal_to_init), !is.na(Sex)) %>%
  summarise(
    across(
      c(signal_to_init, init_to_completion),
      ~ wilcox.test(. ~ Sex)$p.value,
      .names = "p_Sex_{.col}"
    )
  ) %>% 
  kable()
```

```{r time-gender-table, message=FALSE}
reviewed_all %>% 
  # filter(!is.na(Sex)) %>%   # Don't filter for now, so we see when NAs are present.
  group_by(site, cancer_type, Sex) %>% 
  summarise(across(signal_to_init:init_to_completion, q123ms), n=n()) %>% 
  select(!contains(c("mean", "sd"))) %>% 
  unite(signal_to_init_median, signal_to_init_q1, col="signal_to_init", sep=" (") %>% 
  unite(signal_to_init, signal_to_init_q3, col="signal_to_init", sep=" - ") %>% 
  unite(init_to_completion_median, init_to_completion_q1, col="init_to_completion", sep=" (") %>% 
  unite(init_to_completion, init_to_completion_q3, col="init_to_completion", sep=" - ") %>% 
  mutate(across(contains("to"), ~ paste0(.x, ")"))) %>% 
  kable()
```

## Age vs.\ temporality (continuous vs.\ continuous)

```{r helper-fns}
p <- function(spear){
  return(round(spear$p.value, 3))
}

r <- function(spear){
  return(round(spear$estimate, 3))
}
```

```{r size-of-filtered-subset}
reviewed_all %>% 
  group_by(site, cancer_type) %>% 
  mutate(total = n()) %>% 
  count(signal_present, MOD_definite, total) %>% 
  filter(signal_present=="Yes", MOD_definite) %>% 
  mutate(Percent.MOD.and.signal = round(n / total * 100, 1)) %>% 
  select(site, cancer_type, n, total, Percent.MOD.and.signal) %>% 
  kable()
```

Below are $\rho$ coefficients, with "*" meaning significant at $P < 0.05$:

```{r correlations-full-table, message=FALSE, warning=FALSE}
# warnings are about P value with ties.
spear.unpack <- function(vec1, vec2, func) {
  if (sum(is.na(vec1)) == length(vec1)) {
     return(NA)
  }
  if (sum(is.na(vec2)) == length(vec2)) {
     return(NA)
  }
  result <- cor.test(vec1, vec2, method="spearman")
  return(func(result))
}

reviewed_all %>% 
  group_by(site, cancer_type) %>% 
  filter(signal_present=="Yes", MOD_definite) %>% 
  summarise(
    Age_t12_p = spear.unpack(Age, signal_to_init, p),
    Age_t12_r = spear.unpack(Age, signal_to_init, r),
    Age_t23_p = spear.unpack(Age, init_to_completion, p),
    Age_t23_r = spear.unpack(Age, init_to_completion, r),
    t12_t23_p = spear.unpack(signal_to_init, init_to_completion, p),
    t12_t23_r = spear.unpack(signal_to_init, init_to_completion, r),
  ) %>% 
  pivot_longer(
    cols = ends_with(c("_p", "_r")),
    names_to = c("var1", "var2", "stat"),
    names_sep = "_"
  ) %>%
  arrange(desc(site), desc(cancer_type), desc(stat)) %>% 
  pivot_wider(names_from = c(site, cancer_type, stat), values_from = value) %>% 
  
  # Everything below here is just making it look neater. No major calculations.
  
  mutate(across(ends_with(c("_p")), ~ if_else(.<0.05, "*", ""))) %>% 
  mutate(across(ends_with(c("_r")), ~ as.character(.))) %>% 
  mutate(across(starts_with("VA_"), ~ if_else(is.na(.), "", .) )) %>% 
  unite("VA_Lung", starts_with("VA_L"), sep=" ") %>% 
  unite("VA_Colon", starts_with("VA_C"), sep=" ") %>% 
  unite("Geisinger_Lung", starts_with("Geisinger_Lung"), sep=" ") %>% 
  unite("Geisinger_Colon", starts_with("Geisinger_Colon"), sep=" ") %>% 
  mutate(across(
    c(var1, var2),
    ~ case_when(
      . == "t12" ~ "Signal to initation",
      . == "t23" ~ "Initation to completion",
      .default = .
    )
  )) %>% 
  kable()
```

- Turned off `signal_to_init` vs.\ Age plot. With a `geom_smooth()` by LOESS.

```{r t1-age-plot, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE}
reviewed_all %>% 
  filter(signal_present=="Yes", MOD_definite, site!="VA") %>% 
ggplot(aes(x=Age, y=signal_to_init)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  scale_y_sqrt() +
  facet_grid(rows=vars(cancer_type), cols=vars(site))
```

- Turned off `init_to_completion` vs.\ Age plot. With a `geom_smooth()` by LOESS.

```{r t2-age-plot, message=FALSE, warning=FALSE, echo=TRUE, eval=FALSE}
reviewed_all %>% 
  filter(signal_present=="Yes", MOD_definite, site!="VA") %>% 
ggplot(aes(x=Age, y=init_to_completion)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  scale_y_sqrt() +
  coord_cartesian(ylim=c(0,2000)) +
  facet_grid(rows=vars(cancer_type), cols=vars(site))
```

Kept the following plot because it has 3 "significant" $P$ values. In theory, those
indicate negative correlations. On the plots, you can see them, but honestly, they
don't especially jump out. A long $t_{12}$ seems to lead to a short $t_{23}$, at least
by a little bit.

```{r t1-t2-plot, message=FALSE, warning=FALSE}
reviewed_all %>% 
  filter(signal_present=="Yes", MOD_definite) %>% 
ggplot(aes(x=signal_to_init, y=init_to_completion)) +
  geom_jitter(alpha=0.5) +
  #geom_density_2d() +
  geom_smooth() +
  scale_y_sqrt() +
  scale_x_sqrt() +
  #coord_cartesian(xlim=c(0,2000), ylim=c(0,1000)) +
  facet_grid(rows=vars(cancer_type), cols=vars(site))
```

## MOD vs.\ temporality - INSERT ONE?

These plots may be what we should do, versus the MOD-only, descriptive analyses above. Exact quote of what was recommended to analyze:

> time from suspicion to diagnosis

What's 'suspicion'? Is it cancer signal? Or test ordered?

P values:

```{r twelve-tests, message=FALSE, warning=FALSE}
ptext_flat <- function(p) {
  if (p > 0.05) {
    return(NA)
  }
  pt = as.character(round(p, 2))
  return(paste0("P=", pt))
}

ptext <- Vectorize(ptext_flat)

twelve_tests <- reviewed_all %>% 
  select(
    site, cancer_type, MOD_definite,
    signal_to_init, init_to_completion, signal_to_completion
  ) %>% 
  filter(!is.na(  MOD_definite ), signal_to_init > -7, !is.na(init_to_completion)) %>% 
  group_by(site, cancer_type) %>% 
  summarise(across(
    contains("_to_"),
    ~ wilcox.test(. ~ MOD_definite)$p.value
  )) %>% 
  relocate(site, cancer_type, init_to_completion, signal_to_completion, signal_to_init) %>% 
  # Alphabetical, same as the 4x3 boxplot facets.
  mutate(across(contains("_to_"), list(t = ~ptext(.))))

twelve_tests %>% 
  select(!ends_with("_t")) %>% 
  kable()

p_text_for_join <- twelve_tests %>% 
  pivot_longer(ends_with("_t"), names_pattern = "(.*)_t", values_to = "p_text") %>% 
  select(site, cancer_type, name, p_text)
```

```{r assoc-most-detailed-multi-box, message=FALSE, warning=FALSE}
reviewed_all %>% 
  select(
    site, cancer_type, MOD_definite, signal_to_init, init_to_completion,
    signal_to_completion
  ) %>% 
  mutate(across(contains("_to_"), ~ .x / 365)) %>%
  filter(!is.na(  MOD_definite )) %>%
  pivot_longer(cols = signal_to_init:signal_to_completion) %>%
  left_join(p_text_for_join) %>%  # natural join should be on: site, cancer_type, name
  unite(col = "Population", site:cancer_type, sep=" ") %>% 
  
  ggplot(aes(x=value, y = MOD_definite, color= MOD_definite, label=p_text)) +   # x=paste(site, cancer_type), y
  geom_jitter(alpha = 0.5) +
  geom_boxplot(color="black", fill = NA, outliers = FALSE, staplewidth = 0.5, varwidth = TRUE) +
  geom_text(x = 1.25, y = 0.65, color="#444444", size=3) +
  scale_color_hue(l=50) +
  facet_grid(rows = vars(Population), cols=vars(name)) +
  scale_x_continuous(breaks = seq(-1, 2, 1)) +
  coord_cartesian(xlim=c(-1/6, 2.5)) +
  theme(legend.position = "none", panel.grid.major.y = element_blank()) +
  labs(x="Time, y", y="MOD present")
```

I think the intervals just aren't collected a lot when MOD is false. This table shows that:

```{r multi-2-by-2}
reviewed_all %>% 
  select(site, cancer_type, MOD_definite, signal_to_completion) %>% 
  mutate(times_are_recorded = !is.na(signal_to_completion), .keep = "unused") %>% 
  count(site, cancer_type, MOD_definite, times_are_recorded) %>% 
  arrange(site, cancer_type, desc(MOD_definite), desc(times_are_recorded)) %>% 
  pivot_wider(names_from = times_are_recorded, values_from = n, names_prefix = "times_") %>% 
  filter(!is.na(MOD_definite)) %>% 
  mutate(pct = round(times_TRUE / (times_FALSE + times_TRUE) * 100, 1)) %>% 
  kable()
```

- Turned off: $4 \times 2$ boxplot ($x$ axis and color) that shows distribution of
Workup initiation to completion, also known as `init_to_completion`, or $t_{23}$.
It is really a subset of the previous $4 \times 3 \times 2$ boxplot.

```{r simpler-boxplot-for-r1, warning=FALSE, eval=FALSE}
reviewed_all %>% 
  select(site, cancer_type, MOD_definite, init_to_completion) %>% 
  mutate(Years = init_to_completion / 365, .keep = "unused") %>%
  filter(!is.na(MOD_definite)) %>% 
  unite(col = "Population", site:cancer_type, sep=" ") %>% 
  rename(`MOD present` = MOD_definite) %>% 
  ggplot(aes(y = Years, x = Population, color= `MOD present`, group = paste(`MOD present`, Population))) +   # x=paste(site, cancer_type), y
  geom_point(alpha = 0.5, position = position_jitterdodge(jitter.width = 0.2)) +
  geom_boxplot(color="black", fill=NA, outliers = FALSE, staplewidth = 0.5) +
  scale_y_continuous(breaks = seq(-1, 2, 1)) +
  coord_cartesian(ylim =c(-1/12, 2.5)) +
  scale_color_hue(l=50) +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "inside",
    legend.background  = element_rect(color="grey", linewidth = 0.4),
    legend.position.inside = c(0.9, 0.88)
  ) +
  labs(y = "Workup initiation to completion, y")
```

- Turned off: $4 \times 2$ boxplot of
Workup initiation to completion, same as before, but now $y$ axis zoomed in more,
and set to days instead of years.

```{r simpler-boxplot-for-r1-ZOOM, warning=FALSE, eval=FALSE}
reviewed_all %>% 
  select(site, cancer_type, MOD_definite, init_to_completion) %>% 
  filter(
    !is.na(MOD_definite),
    init_to_completion > -300
  ) %>% 
  unite(col = "Population", site:cancer_type, sep=" ") %>% 
  rename(`MOD present` = MOD_definite) %>% 
  ggplot(aes(y = init_to_completion, x = Population, color= `MOD present`, group = paste(`MOD present`, Population))) +   # x=paste(site, cancer_type), y
  geom_point(alpha = 0.7, position = position_jitterdodge(jitter.width = 0.2)) +
  geom_boxplot(color="black", fill=NA, outliers = FALSE, staplewidth = 0.5) +
  scale_y_continuous(breaks = seq(-180, 180*6, 180)) +
  coord_cartesian(ylim =c(0, 400)) +  # 0, 100 worked okay
  scale_color_hue(l=50) +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "inside",
    legend.background  = element_rect(color="grey", linewidth = 0.4),
    legend.position.inside = c(0.9, 0.88)
  ) +
  labs(y = "Workup initiation to completion (days)", title = "Zoomed in")
```

useful commit IDs: `a0cd45253` put it in, `c228851` took it out.

## "Peaks" plot

```{r wacky-time-plot, warning=FALSE}
temp_limit_to_mod <- reviewed_all %>%
  filter(
    MOD_definite,
    signal_to_completion > -7
  ) %>% 
  #arrange(signal_to_completion) %>% 
  #arrange(signal_to_init) %>% 
  arrange(site, cancer_type, signal_to_completion) %>% 
  mutate(
    patient_id = row_number(),
    vmin = signal_to_init,
    vmax = signal_to_completion,
    Population = paste(site, cancer_type)
  ) %>% 
  pivot_longer(
    cols = c("signal_to_init", "signal_to_completion"),
    names_to = "interval_type",
    names_prefix = "signal_to_"
  ) %>% 
  mutate(
    point_shape = case_when(
      interval_type == "init" ~ 4,  # X shape
      interval_type == "completion" ~ 3,  # + shape
    ),
    Workup = case_when(
      interval_type == "init" ~ "Initiated",
      interval_type == "completion" ~ "Completed",
    )
  )
  
LW <- 0.8

temp_limit_to_mod %>% 
  ggplot(aes(y = value, x = patient_id, colour = Population)) +
  geom_linerange(aes(ymin = vmin, ymax=vmax), linewidth=LW) +
  geom_linerange(aes(ymin = 0, ymax=vmin), color="lightgrey", linewidth=LW) +
  geom_point(aes(shape = Workup) , color="black", alpha=0.5) +
  coord_cartesian(ylim = c(-2, 750)) +
  scale_y_continuous(breaks = seq(0, 9000, 180), minor_breaks = seq(0,9000, 30)) +
  scale_shape_manual(values = c(3, 4)) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  labs(y = "Time since cancer signal (days)")

#ggsave("peaks.pdf")
```

# My to-do list: data and analyses

- Comprehensive data
    - [x] `lung_raw`
    - [x] `colon_raw` (both VA comprehensive)
- Chart review data
    - [x] `reviewed_geis_lung` (Geisinger chart review)
    - [x] `colon_geis_raw`
    - [x] `lung_va_raw`
    - [x] `colon_va_raw`
    - [x] VA date data (re-export?)
    - [x] ...and sex, and age.
- Analyses
    - [x] Oh dear, what if "date of completion" varies by reviewer.
    - [x] All the fix comments, related to Spearman's $\rho$ handling `NA` values, and stratifying by site and cancer type.

# Reviewers' list

- Descriptive stats (large scale)
    - flow diagram (R1 C1)
        - [x] specifically about PCP visit
    - [x] missingness R1 C1. Specifically of stage.
    - [x] demographics (by health sys)
- Manual review stats
    - description of temporal distribution
        - [x] Ed: bin them with breaks at like 3, 6, 12 months.
    - temporal vs demographic (assoc)
    - temporal vs MOD (assoc)
    - really which reviewer wants assoc stats?
    - [x] CIs for percent of MOD (descriptive)
- [x] Geisinger data

# R version details

```{r version, echo=TRUE}
R.version.string

rstudioapi::versionInfo()$version

si <- sessionInfo()
for (i in 1:length(si$otherPkgs)) {
  cat(si$otherPkgs[[i]]$Package, si$otherPkgs[[i]]$Version, "\n")
}
```

# Data dimensions and variables

*All data:*

```{r dim-col-comprehensive, echo=TRUE}
dim(all_data)
colnames(all_data)
```

*Chart review data:*

```{r dim-col-reviews, echo=TRUE}
dim(reviewed_all)
colnames(reviewed_all)
```

# Tidying summary

List of vars that I actually analyze (see auto-printed list above):

1. `Sex`
1. Stage (early/advanced)
1. `Race`
1. `Age`
1. `cancer_type`
1. `site` (VA/Geisinger)
1. `MOD_present_main_outcome` $\to$ No. You should use `MOD_definite`
1. `signal_present`
1. `cancer_dx_considered`
1. `signal_date`
1. `dx_eval_init_date`
1. `dx_eval_complete_date`
1. `signal_type`: tidied but not (yet) used
1. `screening_declined`
1. signal to init to completion date intervals

Don't seem to have:

- Geisinger full data (to see about PCP exclusion)
- Geisinger non-late-stage
- VA $n = 100$ sample demographics
