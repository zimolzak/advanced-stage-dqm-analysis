---
title: "Late Stage Associations"
author: "Andrew Zimolzak, MD, MMSc"
date: "`r Sys.Date()`"
output: pdf_document
---

# To Do

## My list: data and analyses

- Comprehensive data
    - [x] `lung_raw`
    - [x] `colon_raw` (both VA comprehensive)
- Chart review data
    - [x] `reviewed_geis_lung` (Geisinger chart review)
    - [x] `colon_geis_raw`
    - [x] `lung_va_raw`
    - [x] `colon_va_raw`
    - [x] VA date data (re-export?)
    - [x] ...and sex, and age.
- Analyses
    - [x] Oh dear, what if "date of completion" varies by reviewer.
    - [x] All the fix comments, related to Spearman's $\rho$ handling `NA` values, and stratifying by site and cancer type.

## Reviewers' list

- Descriptive stats (large scale)
    - flow diagram (R1 C1)
        - [x] specifically about PCP visit
    - [x] missingness R1 C1. Specifically of stage.
    - [x] demographics (by health sys)
- Manual review stats
    - description of temporal distribution
        - [x] Ed: bin them with breaks at like 3, 6, 12 months.
    - temporal vs demographic (assoc)
    - temporal vs MOD (assoc)
    - really which reviewer wants assoc stats?
    - [x] CIs for percent of MOD (descriptive)
- [x] Geisinger data




# Intro

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(knitr)
library(tidyr)
library(Hmisc)
library(forcats)
# consider later: clean_names() from {janitor} 

knitr::opts_chunk$set(echo = FALSE)  # Sets the default to "Run but don't show code."
```

## Versions

```{r version, echo=TRUE}
R.version.string

rstudioapi::versionInfo()$version

si <- sessionInfo()
for (i in 1:length(si$otherPkgs)) {
  cat(si$otherPkgs[[i]]$Package, si$otherPkgs[[i]]$Version, "\n")
}
```




# Import and tidy

```{r read, include=FALSE}

# Comprehensive

lung_raw <- read_csv("VA Lung comprehensive.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Lung", site="VA")

colon_raw <- read_csv("VA Colon comprehensive.csv", show_col_types = FALSE) %>%
  mutate(cancer_type = "Colon", site="VA")

geisinger_comprehensive <- tribble(
  ~site, ~cancer_type, ~n, ~Stage,
  "Geisinger", "Lung", 1699, "Advanced",
  "Geisinger", "Lung", 2914, "Total",
  "Geisinger", "Colon", 227, "Advanced",
  "Geisinger", "Colon", 627, "Total",
)

# Chart review

geis_columns <- read_csv("geis_colnames.csv", show_col_types = FALSE)
coltype_spec <- paste0(geis_columns$type, collapse="")
lung_geis_raw <- read_csv("final lung LS for Houston de-id Divvy 3-28-22.csv",
                          col_types = coltype_spec,
                          show_col_types = FALSE)  # mutate *after* assigning column names.

colon_geis_raw <- read_csv("Late Stage CRC Final DU 1-26-22.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Colon", site="Geisinger")

lung_va_raw <- read_csv("deid-again-2025-01/deid+MM3_LC_Export_Added1OfMissing3.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Lung", site="VA")

colon_va_raw <- read_csv("deid-again-2025-01/deid+MM3_CRC_Export.csv", show_col_types = FALSE) %>% 
  mutate(cancer_type = "Colon", site="VA") %>% 
  filter(!is.na(CancerStage)) %>%  # filter garbage rows at end (leftover of Excel)
  rename(siginit = `siginit-neg-never`)
```

```{r tidy-comprehensive}
all_data <- bind_rows(colon_raw, lung_raw) %>%
  mutate(
    Sex = case_when(PatientSex == 1 ~ "M",TRUE ~ "F"),
    Stage = as.factor(case_when(
      IsLate == 0 ~ "Early",
      IsLate == 1 ~ "Advanced",
      TRUE ~ "unknown"
    )),
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  ) %>%
  rename(
    StageGroupNumeric = StageOfCancer,
    Age = PatientAgeCapped
  ) %>% 
  relocate(site, cancer_type, Sex, Race, Age, Stage)

rm(colon_raw, lung_raw)  # keep geisinger_comprehensive for later
```

```{r dim-col-comprehensive, echo=TRUE}
dim(all_data)
colnames(all_data)
```

```{r tidy-chart-reviews, message=FALSE}
colnames(lung_geis_raw) <- geis_columns$name

yr_offset <- 365.25 * (2016 - 1970)  # to generate fake VA dates

reviewed_geis_lung <- lung_geis_raw %>%
  mutate(
    cancer_type = "Lung",
    site="Geisinger",
    MOD_definite = case_when(
      MOD_present_main_outcome == "Yes" ~ TRUE,
      MOD_present_main_outcome == "No" ~ FALSE,
      MOD_present_main_outcome == "Unsure" ~ FALSE,
      TRUE ~ NA
    )
  ) %>% 
  rename(Sex = Gender) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race,  # Location,
    signal_present, cancer_dx_considered, MOD_present_main_outcome, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type
  )

reviewed_geis_colon <- colon_geis_raw %>% 
  rename(
    Age = `Age:`,
    modtext = `Is there a missed opportunity (in general) in this case?`
  ) %>% 
  mutate(
    Sex = as.factor(`Gender:`),
    Race = as.factor(case_when(
      `Ethnicity:` == "HISPANIC OR LATINO" ~ "Hispanic or Latino",
      TRUE ~ `Race:`
    )),
    Location = as.factor(`Location:`),
    signal_present = as.factor(
      `Prior to index presentation, were there any cancer signals (important/relevant findings)?`
    ),
    MOD_definite = case_when(
      modtext == "Yes" ~ TRUE,
      modtext == "No" ~ FALSE,
      modtext == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    cancer_dx_considered = as.factor(`Was a cancer diagnosis considered at the time of the earliest cancer signal?`),
    signal_date = as.Date(`When was it recorded?`),
    dx_eval_init_date = as.Date(`When was cancer-related diagnostic evaluation initiated?`),
    dx_eval_complete_date = as.Date(`When was the evaluation completed?`),
    signal_type = as.factor(`What was the earliest cancer signal recorded?`),
    .keep = "unused"
  ) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date
  )

reviewed_va_lung_colon <- lung_va_raw %>% 
  bind_rows(colon_va_raw) %>% 
  mutate(
    siginit = case_when(
      siginit < -40000 ~ NA,
      .default = siginit
    ),
    initcomp = case_when(
      initcomp < -40000 ~ NA,
      .default = initcomp
    ),
    signal_present = as.factor(RFYesNo),
    cancer_dx_considered = as.factor(RFInitialCancerDxConsidered),
    MOD_definite = case_when(
      DxMOD == "Yes" ~ TRUE,
      DxMOD == "No" ~ FALSE,
      DxMOD == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    signal_date = as.Date(yr_offset),
    dx_eval_init_date = as.Date(siginit + yr_offset),
    dx_eval_complete_date = as.Date(siginit + initcomp + yr_offset),
    signal_type = as.factor(RFInitialRF)
  ) %>% 
  relocate(
    site, cancer_type,  # Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type,
    siginit, initcomp
  )

# IMPORTANT list of kept variables below.

reviewed_all <- bind_rows(
    reviewed_geis_colon, reviewed_geis_lung, reviewed_va_lung_colon
  ) %>% 
  select(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date,
    Reviewer
  ) %>% 
  mutate(
    across(c(site, cancer_type), as.factor),
    Sex = fct_collapse(Sex, M = "MALE", F = "FEMALE"),
    
    # NOTE the different naming "signal" vs "sig", and "completion" vs "complete"
    
    signal_to_init = as.numeric(dx_eval_init_date - signal_date),
    init_to_completion = as.numeric(dx_eval_complete_date - dx_eval_init_date),
    signal_to_completion = as.numeric(dx_eval_complete_date - signal_date)
  )
```

## About "patient declined"

```{r declined}
reviewed_va_lung_colon %>% 
  count(site, cancer_type, PtDecline) %>% 
  kable()

cat('x')

reviewed_geis_colon %>% 
  count(site, cancer_type, `Was a colonoscopy screening performed prior to index visit?`) %>% 
  kable()

reviewed_geis_colon %>% 
  count(site, cancer_type, `Did the patient decline screening colonoscopies in the past?`) %>% 
  kable()

reviewed_geis_lung %>% 
  count(site, cancer_type, ldct_offered) %>% 
  kable()

reviewed_geis_lung %>% 
  count(site, cancer_type, ldct_declined) %>% 
  kable()
```

```{r remove-chart-rev-bits}
rm(lung_va_raw, colon_va_raw, lung_geis_raw, colon_geis_raw)
rm(coltype_spec, geis_columns)
rm(reviewed_geis_colon, reviewed_geis_lung, reviewed_va_lung_colon)
```

```{r dim-col-reviews, echo=TRUE}
dim(reviewed_all)
colnames(reviewed_all)
```

\newpage

## Tidying summary

List of vars that I actually analyze:

- Sex
- Stage (early/advanced)
- Race
- Age
- cancer_type
- site (VA/Geisinger)
- `MOD_present_main_outcome` $\to$ No. You should use `MOD_definite`
- `signal_present`
- `cancer_dx_considered`
- `signal_date`
- `dx_eval_init_date`
- `dx_eval_complete_date`
- `signal_type`: tidied but not (yet) used

Might not have:

- Geisinger full data (to see about PCP exclusion)
- Geisinger non-late-stage
- VA $n = 100$ sample demographics




# Descriptives: comprehensive data

```{r definitions}
percentage_text <- function(numerator, denominator) {
  # It appears to be already vectorized.
  ntext <- as.character(numerator)
  dtext <- as.character(denominator)
  ptext <- as.character(round(numerator / denominator * 100, 1))
  final_text <- paste0(ntext, " / ", dtext, " (", ptext, "%)")
  return(final_text)
}



pct_ci_text <- function(numerator, denominator) {
  low = binconf(numerator, denominator)[,"Lower"]
  upp = binconf(numerator, denominator)[,"Upper"]
  ptext <- as.character(round(numerator / denominator * 100, 1))
  ltext <- as.character(round(low * 100, 1))
  utext <- as.character(round(upp * 100, 1))
      
  final_text <- paste0(ptext, "% (", ltext, "-", utext, ")")
  return(final_text)
}


q123ms <- list(
  q1 = ~quantile(.x, 0.25, na.rm = TRUE),
  median = ~quantile(.x, 0.5, na.rm = TRUE),
  q3 = ~quantile(.x, 0.75, na.rm = TRUE),
  mean = ~round(mean(.x, na.rm=TRUE), 2),
  sd = ~round(sd(.x, na.rm = TRUE), 2)
)
```

```{r prep-categor-subtables, message=FALSE}
compr_sex <- all_data %>%
  group_by(site, cancer_type) %>% 
  count(Sex) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent = percentage_text(n, d), .keep = "unused") %>% 
  filter(Sex == "M") %>% 
  pivot_wider(names_from = cancer_type, values_from = Percent) %>% 
  mutate(Characteristic = "Sex") %>% 
  rename(Level = Sex)

compr_race <- all_data %>%
  group_by(site, cancer_type) %>% 
  count(Race) %>% 
  mutate(d = sum(n)) %>% 
  arrange(desc(cancer_type), desc(n)) %>% 
  mutate(Percent = percentage_text(n, d), .keep = "unused") %>% 
  pivot_wider(names_from = cancer_type, values_from = Percent) %>% 
  mutate(Characteristic = "Race") %>% 
  rename(Level = Race)

compr_age <- all_data %>%
  group_by(site, cancer_type) %>% 
  summarise(across(Age, q123ms)) %>% 
  unite(col = quartiles, c(Age_median, Age_q1), sep = " (") %>% 
  unite(col = quartiles, c(quartiles, Age_q3), sep = " - ") %>% 
  mutate(quartiles = paste0(quartiles, ")")) %>% 
  select(site, cancer_type, quartiles) %>% 
  pivot_wider(names_from = cancer_type, values_from = quartiles) %>% 
  mutate(Characteristic = "Age")
```

```{r kable-descr-comprehensive}
compr_adv <- rbind(  # FIXME_maybe - should we use bind_rows() ?
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count() %>%
    mutate(Stage = "Total"),  # denominator, basically
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count(Stage)  # numerators Advanced & Early
) %>%
  filter(Stage != "Early") %>%  # just 1 numerator
  bind_rows(geisinger_comprehensive) %>% 
  arrange(desc(site), desc(cancer_type), Stage) %>% 
  pivot_wider(names_from = c(site, cancer_type, Stage), values_from = n) %>% 
  mutate(
    VA_Lung = percentage_text(VA_Lung_Advanced, VA_Lung_Total),
    VA_Colon = percentage_text(VA_Colon_Advanced, VA_Colon_Total),
    Geisinger_Lung = percentage_text(Geisinger_Lung_Advanced, Geisinger_Lung_Total),
    Geisinger_Colon = percentage_text(Geisinger_Colon_Advanced, Geisinger_Colon_Total),
    Characteristic = "Advanced stage",
    .keep = "unused"
  )

bind_rows(compr_sex, compr_race, compr_age) %>% 
  ungroup() %>% 
  select(Characteristic, Level, Lung, Colon) %>% 
  rename(VA_Lung = Lung, VA_Colon = Colon) %>%   # have to rename first
  bind_rows(compr_adv) %>% 
  kable()

rm(compr_adv, compr_age, compr_race, compr_sex)
```

## Figure: age

```{r plot-age-simple}
all_data %>% 
  ggplot(aes(x=Age)) +
  geom_histogram(binwidth = 2) +
  facet_grid(rows=vars(cancer_type))
```

## For editor comment (PCP visit criterion/flow)

```{r pcp-stats, message=FALSE}
all_data %>%
  group_by(site, cancer_type) %>%
  summarise(
    pts=n(), pcp1=sum(HasPCPBeforeCutOff) ,pcp2=sum(HasPCPAfterCutOff),
    percent_before_cutoff=percentage_text(pcp1, pts),
    percent_after_cutoff=percentage_text(pcp2, pts)
  ) %>% 
  select(site, cancer_type, percent_before_cutoff, percent_after_cutoff) %>% 
  kable()
```

## For R1 comment (missingness)

> How did the authors deal with unknown/incomplete stage cases in cohort construction and calculation of the % advanced stage?

```{r stage-missingness-fancy, message=FALSE}
all_data %>%
  group_by(site, cancer_type, StageGroupNumeric) %>% 
  summarise(n = n(), n_missing = sum(is.na(StageGroupNumeric))) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent.at.stage = percentage_text(n, d), .keep = "unused") %>% 
  relocate(site, cancer_type, StageGroupNumeric, Percent.at.stage, n_missing) %>% 
  kable()
```




# Descriptives: chart review 

```{r generate-table-ci}
va_population_ci <- all_data %>%
  group_by(site, cancer_type) %>% 
  count(Sex) %>% 
  mutate(d = sum(n)) %>% 
  mutate(
    Fact = "Sex",
    Val = Sex,
    .keep = "unused"
  )

chart_rev_confint <- bind_rows(
  # Build up 4 "sub-tables," one for each of 4 categorical vars of interest.
  # (MOD, sex, signal, considered)
  # Each sub-table is like:
  # site, cancer_type, Fact, Val, n, d
  # VA,   Colon,       Sex,  F,   55, 100.
  
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, MOD_definite) %>% filter(!is.na(MOD_definite)) %>%
    mutate(d = sum(n), Fact = "MOD", Val=as.character(MOD_definite)) %>% 
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, Sex) %>% filter(!is.na(Sex)) %>%
    mutate(d = sum(n), Fact = "Sex", Val=as.character(Sex)) %>% 
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, signal_present) %>% filter(!is.na(signal_present)) %>%
    mutate(d = sum(n), Fact = "Ca signal", Val=as.character(signal_present)) %>% 
    select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    filter(!is.na(cancer_dx_considered)) %>% count(site, cancer_type, cancer_dx_considered) %>%
    mutate(d = sum(n), Fact = "Ca considered", Val=as.character(cancer_dx_considered)) %>%  
    select(site, cancer_type, Fact, Val, n, d),
  va_population_ci
) %>% 
  mutate(
    Percentage = percentage_text(n, d),
    P_CI_short = pct_ci_text(n, d),
    wilson.poi = binconf(n, d)[,"PointEst"],
    wilson.low = binconf(n, d)[,"Lower"],
    wilson.upp = binconf(n, d)[,"Upper"]
  ) %>% 

  filter(
    # Exclude a few rows because it is redundant to say 25% true, 75% false. Just
    # mention one of these %s.
    (Fact == "MOD" & Val == TRUE) |
      (Fact == "Sex" & Val == "M") |
      (Fact == "Ca signal" & Val == "Yes") |  # Assume NA = no signal.
      (Fact == "Ca considered" & Val == "No")  # Assume Unsure = considered.
  ) %>% 
  unite(col=Characteristic, Fact, Val, sep=" ") %>% 
  arrange(desc(site), desc(cancer_type), Characteristic)
```

## Detailed

```{r kable-descr-reviews}
chart_rev_confint %>%
  select(site, cancer_type, Characteristic, Percentage, wilson.low, wilson.upp) %>% 
  mutate(across(starts_with("wilson"), ~ round(.x * 100, 1) )) %>% 
  unite(wilson.low, wilson.upp, col="Wilson_CI", sep = "-") %>% 
  unite(col=Percent_CI, Percentage, Wilson_CI, sep = " ") %>% 
  pivot_wider(names_from = c(site, cancer_type), values_from = Percent_CI) %>% 
  kable()
# print the detailed one now.

review_ci_concise <- chart_rev_confint %>%
  select(site, cancer_type, Characteristic, P_CI_short) %>% 
  pivot_wider(names_from = c(site, cancer_type), values_from = P_CI_short)
# We do bind_rows()  on this later.

```

```{r plot-ci}
chart_rev_confint %>% 
  ggplot(aes(x = wilson.poi, y = Characteristic, colour = site)) +
  facet_grid(rows=vars(cancer_type)) +
  geom_point() +
  geom_errorbar(aes(xmin = wilson.low, xmax = wilson.upp))
```

\newpage

```{r functions-continuous-vars}
median_text_scalar <- function(m, q1, q3){
  vec <- c(
    as.character(round(m, 1)),
    " (",
    as.character(round(q1, 1)),
    " - ",
    as.character(round(q3, 1)),
    ")"
  )
  return(paste0(vec, collapse = ""))
}

mean_text_scalar <- function(m, s){
  vec <- c(
    as.character(round(m, 1)),
    " (",
    as.character(round(s, 1)),
    ")"
  )
  return(paste0(vec, collapse = ""))
}

median_text <- Vectorize(median_text_scalar)
mean_text <- Vectorize(mean_text_scalar)
```

## TABLE 1

```{r kable-descriptives-allvars-strat, message=FALSE}
reviewed_all %>% 
  group_by(site, cancer_type) %>% 
  summarise(across(c(Age, signal_to_init, init_to_completion, signal_to_completion), q123ms)) %>% 
  pivot_longer(
    cols = starts_with(c("Age", "signal", "init")),
    names_to = c("variable", "statistic"),
    names_pattern = "(.*)_(.*)"
  ) %>%
  filter(statistic!="mean", statistic!="sd") %>% 
  pivot_wider(names_from = statistic, values_from = value) %>% 
  # mutate(across(c(q1, median, q3, mean, sd), ~ round(.x, 1))) %>% 
  mutate(
    median_q1_q3 = median_text(median, q1, q3),
    # mean_sd = mean_text(mean, sd),
    .keep = "unused"
  ) %>% 
  pivot_wider(
    names_from = c(site, cancer_type),
    values_from = median_q1_q3
  ) %>% 
  relocate(variable, VA_Lung, VA_Colon, Geisinger_Lung, Geisinger_Colon) %>% 
  rename(Characteristic = variable) %>%
  bind_rows(review_ci_concise) %>% 
  kable()
```

## Misc.

```{r descrip-facet-age, warning=FALSE}
ggplot(reviewed_all %>% filter(site !="VA"), aes(x=Age)) +
  geom_histogram(binwidth = 2) +
  facet_grid(vars(site, cancer_type))
```

## FIGURE to include - Time with custom breaks

```{r constants}
yearly = seq(0, 6000, 365)
monthly = seq(0, 6000, 365/12)
quarterly = seq(0, 6000, 365/4)
THREE_MONTHS = 365 / 4

year_breaks_custom <- c(c(0, 0.25, 0.5), seq(1, 17, 1))
day_breaks_custom <- year_breaks_custom * 365
```

What we want:

> temporal distribution of MODs, with regard to diagnosis (i.e. how many occurred <3 months prior to appropriate evaluation/diagnosis, vs 3–6 months, 6–12 mos, etc)....

```{r constants-ed}
year_breaks_ed <- c(0, 0.25, 0.5, 1, 2, 3 ,4, 20)
month_breaks_ed <- year_breaks_ed * 12
day_breaks_ed <- year_breaks_ed * 365
```

```{r boxplot-s2c}
reviewed_all %>% 
  filter(MOD_definite == TRUE, signal_to_completion >= 0) %>% 
  mutate(
    signal_to_completion_yrs = signal_to_completion/365.25,
    Population = paste(site, cancer_type)
  ) %>% 
ggplot(aes(x=signal_to_completion_yrs, y = Population)) +
  geom_boxplot(staplewidth = 0.15) +
  #facet_grid(vars(site, cancer_type)) +
  coord_cartesian(xlim=c(0, 10)) +
  scale_x_continuous(breaks = yearly/365, minor_breaks = quarterly/365) +
  labs(title="Limited to MOD only")
```

```{r table-binning}
reviewed_all %>% 
  filter(MOD_definite == TRUE) %>% 
  mutate(
    months = signal_to_completion /  (365 / 12),
    signal_to_completion_months = cut(months, breaks=month_breaks_ed),
    .before = everything()
  ) %>% 
  group_by(site, cancer_type) %>% 
  count(signal_to_completion_months, .drop = FALSE) %>% 
  mutate(s = sum(n), Percent = percentage_text(n, s), .before = everything()) %>% 
  select(site, cancer_type, Percent, signal_to_completion_months) %>% 
  pivot_wider(id_cols = signal_to_completion_months, names_from = c(site, cancer_type), values_from = Percent) %>% 
  kable()
```

\newpage




# Associations: comprehensive data

```{r construct-pvals}
colon <- all_data %>% filter(cancer_type == "Colon")
lung <- all_data %>% filter(cancer_type == "Lung")

tab_colon_sex <- table(colon$Sex, colon$Stage)
chi_colon_sex <- chisq.test(tab_colon_sex)
p_colon_sex <- chi_colon_sex$p.value

tab_colon_race <- table(colon$Race, colon$Stage)
chi_colon_race <- chisq.test(tab_colon_race)
p_colon_race <- chi_colon_race$p.value

tab_lung_sex <- table(lung$Sex, lung$Stage)
chi_lung_sex <- chisq.test(tab_lung_sex)
p_lung_sex <- chi_lung_sex$p.value

tab_lung_race <- table(lung$Race, lung$Stage)
chi_lung_race <- chisq.test(tab_lung_race)
p_lung_race <- chi_lung_race$p.value

wilc_colon_age <- wilcox.test(
  colon %>% filter(Stage == "Advanced") %>% pull(Age),
  colon %>% filter(Stage == "Early") %>% pull(Age)
)
p_colon_age <- wilc_colon_age$p.value

wilc_lung_age <- wilcox.test(
  lung %>% filter(Stage == "Advanced") %>% pull(Age),
  lung %>% filter(Stage == "Early") %>% pull(Age)
)
p_lung_age <- wilc_lung_age$p.value

rm(chi_colon_race, chi_colon_sex, chi_lung_race, chi_lung_sex)
rm(tab_colon_race, tab_colon_sex, tab_lung_race, tab_lung_sex)
```

All $P$ values are by $\chi^2$.

```{r categorical-assoc}
assoc_r <- all_data %>%
  count(cancer_type, Stage, Race) %>%
  mutate(Factor = "Race") %>% 
  rename(Level = Race)

assoc_s <- all_data %>%
  count(cancer_type, Stage, Sex) %>%
  mutate(Factor = "Sex") %>% 
  rename(Level = Sex)

assoc <- bind_rows(assoc_r, assoc_s) %>% 
  pivot_wider(names_from = c(cancer_type, Stage), values_from = n) %>%
  mutate(
    Colon_Denom = Colon_Early + Colon_Advanced,
    Lung_Denom = Lung_Early + Lung_Advanced,
    Colon_Rate = round(Colon_Advanced / Colon_Denom * 100, 1),
    Lung_Rate = round(Lung_Advanced / Lung_Denom * 100, 1),
    p_colon = case_when(Factor == "Race" ~ round(p_colon_race, 3), Factor == "Sex" ~ round(p_colon_sex, 3)),
    p_lung = case_when(Factor == "Race" ~ round(p_lung_race, 3), Factor == "Sex" ~ round(p_lung_sex, 3))
  ) %>%
  select(
    Factor, Level,
    Colon_Advanced, Colon_Denom, Colon_Rate, p_colon,
    Lung_Advanced, Lung_Denom, Lung_Rate, p_lung
  )

rm(assoc_r, assoc_s)

assoc %>% 
  arrange(Factor, desc(Lung_Denom)) %>% 
  unite(Colon_Advanced, Colon_Denom, col="Colon_VA", sep = " / ") %>% 
  unite(Colon_VA, Colon_Rate, col="Colon_VA_advanced", sep=" (") %>% 
  unite(Lung_Advanced, Lung_Denom, col="Lung_VA", sep = " / ") %>% 
  unite(Lung_VA, Lung_Rate, col="Lung_VA_advanced", sep=" (") %>% 
  mutate(across(c(Colon_VA_advanced, Lung_VA_advanced), ~ paste0(.x, ")"))) %>%
  # neat trick to add close paren
  kable()
```

## Age vs. advanced

```{r plot-age-facetted, message=FALSE, warning=FALSE}
ggplot(all_data, aes(Age, fill=Stage, color=Stage)) +
  geom_density(alpha=0.3) +
  facet_grid(rows=vars(cancer_type)  ) +
  xlim(20, 100)
```

All $P$ values are by Wilcoxon.

```{r age-assoc, message=FALSE}
all_data %>% 
  group_by(cancer_type, Stage) %>% 
  summarise(across(Age, q123ms), n=n()) %>% 
  unite(Age_median, Age_q1, col="Median_Q1", sep = " (") %>% 
  unite(Median_Q1, Age_q3, col = "Age_quartiles", sep = " - ") %>% 
  unite(Age_mean, Age_sd, col="Age_mean_SD", sep = " (") %>% 
  mutate(across(starts_with("Age_"), ~ paste0(.x, ")"))) %>% 
  mutate(P_value = case_when(
    cancer_type == "Colon" ~ round(p_colon_age, 3),
    TRUE ~ p_lung_age  # Trying to show very low P without rounding.
  )) %>% 
  select(cancer_type, Stage, n, Age_mean_SD, P_value) %>%   
  # drops Age_quartiles because it wasn't very informative
  kable()
```

```{r text-prep}
mean_ages_lung <- all_data %>% 
  filter(cancer_type=="Lung") %>% 
  group_by(Stage) %>% 
  summarise(m=mean(Age)) %>% 
  arrange(Stage)

r2 <- function(n) {
  d <- 2
  r <- round(n, d)
  f <- format(r, nsmall = d)
  return(f)
}

mala <- mean_ages_lung[1,] %>% pull(m)
mall <- mean_ages_lung[2,] %>% pull(m)
maldiff <- abs(mala - mall)
```

No difference in age between colon advanced and colon early. Lung advanced skews slightly earlier than lung early (`r r2(mala)` vs. `r r2(mall)` years, difference of `r r2(maldiff)`).




# Associations: chart review

## Time vs. gender

$P$ values here are by Wilcoxon.

```{r good-wilcox, message=FALSE, warning=FALSE}
reviewed_all %>%
  group_by(site, cancer_type) %>%
  filter(!is.na(signal_to_init), !is.na(Sex)) %>%
  summarise(
    across(
      c(signal_to_init, init_to_completion),
      ~ wilcox.test(. ~ Sex)$p.value,
      .names = "p_Sex_{.col}"
    )
  ) %>% 
  kable()
```

```{r time-gender-table, message=FALSE}
reviewed_all %>% 
  # filter(!is.na(Sex)) %>%   # Don't filter for now, so we see when NAs are present.
  group_by(site, cancer_type, Sex) %>% 
  summarise(across(signal_to_init:init_to_completion, q123ms), n=n()) %>% 
  select(!contains(c("mean", "sd"))) %>% 
  unite(signal_to_init_median, signal_to_init_q1, col="signal_to_init", sep=" (") %>% 
  unite(signal_to_init, signal_to_init_q3, col="signal_to_init", sep=" - ") %>% 
  unite(init_to_completion_median, init_to_completion_q1, col="init_to_completion", sep=" (") %>% 
  unite(init_to_completion, init_to_completion_q3, col="init_to_completion", sep=" - ") %>% 
  mutate(across(contains("to"), ~ paste0(.x, ")"))) %>% 
  kable()
```

\newpage




## Age vs. times $\rho$ coefficients

```{r helper-fns}
p <- function(spear){
  return(round(spear$p.value, 3))
}

r <- function(spear){
  return(round(spear$estimate, 3))
}
```

```{r size-of-filtered-subset}
reviewed_all %>% 
  group_by(site, cancer_type) %>% 
  mutate(total = n()) %>% 
  count(signal_present, MOD_definite, total) %>% 
  filter(signal_present=="Yes", MOD_definite) %>% 
  mutate(Percent.MOD.and.signal = round(n / total * 100, 1)) %>% 
  select(site, cancer_type, n, total, Percent.MOD.and.signal) %>% 
  kable()
```

```{r correlations-full-table, message=FALSE, warning=FALSE}
# warnings are about P value with ties.
spear.unpack <- function(vec1, vec2, func) {
  if (sum(is.na(vec1)) == length(vec1)) {
     return(NA)
  }
  if (sum(is.na(vec2)) == length(vec2)) {
     return(NA)
  }
  result <- cor.test(vec1, vec2, method="spearman")
  return(func(result))
}

reviewed_all %>% 
  group_by(site, cancer_type) %>% 
  filter(signal_present=="Yes", MOD_definite) %>% 
  summarise(
    Age_t12_p = spear.unpack(Age, signal_to_init, p),
    Age_t12_r = spear.unpack(Age, signal_to_init, r),
    Age_t23_p = spear.unpack(Age, init_to_completion, p),
    Age_t23_r = spear.unpack(Age, init_to_completion, r),
    t12_t23_p = spear.unpack(signal_to_init, init_to_completion, p),
    t12_t23_r = spear.unpack(signal_to_init, init_to_completion, r),
  ) %>% 
  pivot_longer(
    cols = ends_with(c("_p", "_r")),
    names_to = c("var1", "var2", "stat"),
    names_sep = "_"
  ) %>%
  arrange(desc(site), desc(cancer_type), desc(stat)) %>% 
  pivot_wider(names_from = c(site, cancer_type, stat), values_from = value) %>% 
  
  # Everything below here is just making it look neater. No major calculations.
  
  mutate(across(ends_with(c("_p")), ~ if_else(.<0.05, "*", ""))) %>% 
  mutate(across(ends_with(c("_r")), ~ as.character(.))) %>% 
  mutate(across(starts_with("VA_"), ~ if_else(is.na(.), "", .) )) %>% 
  unite("VA_Lung", starts_with("VA_L"), sep=" ") %>% 
  unite("VA_Colon", starts_with("VA_C"), sep=" ") %>% 
  unite("Geisinger_Lung", starts_with("Geisinger_Lung"), sep=" ") %>% 
  unite("Geisinger_Colon", starts_with("Geisinger_Colon"), sep=" ") %>% 
  mutate(across(
    c(var1, var2),
    ~ case_when(
      . == "t12" ~ "Signal to initation",
      . == "t23" ~ "Initation to completion",
      .default = .
    )
  )) %>% 
  kable()
```

## Initiation time vs. age

```{r ia-plot, message=FALSE, warning=FALSE}
reviewed_all %>% 
  filter(signal_present=="Yes", MOD_definite, site!="VA") %>% 
ggplot(aes(x=Age, y=signal_to_init)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  scale_y_sqrt() +
  facet_grid(rows=vars(cancer_type), cols=vars(site))
```

Is it Spearman that does not like `NA`? **No.** Really it's that `temporal` only ever used to use lung! It ignored colon.

## Completion time vs. age

```{r completion-age-plots, message=FALSE, warning=FALSE}
reviewed_all %>% 
  filter(signal_present=="Yes", MOD_definite, site!="VA") %>% 
ggplot(aes(x=Age, y=init_to_completion)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  scale_y_sqrt() +
  coord_cartesian(ylim=c(0,2000)) +
  facet_grid(rows=vars(cancer_type), cols=vars(site))
```

\newpage

## Initiation time vs. completion time

```{r init-completion-wacky-plots, warning=FALSE}
reviewed_all %>% 
  filter(signal_present=="Yes", MOD_definite) %>% 
ggplot(aes(x=signal_to_init, y=init_to_completion)) +
  geom_jitter(alpha=0.5) +
  geom_density_2d() +
  scale_y_sqrt() +
  scale_x_sqrt() +
  coord_cartesian(xlim=c(0,2000), ylim=c(0,1000)) +
  facet_grid(rows=vars(cancer_type), cols=vars(site))
```
