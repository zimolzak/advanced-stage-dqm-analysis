---
title: "Late Stage Associations"
author: "Andrew Zimolzak"
date: "`r Sys.Date()`"
output: pdf_document
---

# Summary (VA data)

## Colon

- Race is significant. 34.1% white versus 30.8% black.

## Lung

- Sex is predictive, 46.2% vs 42.7% in women.
- Race is significant. 48.2% black vs 45.7% white
- Age is significant. 70.5 years in late, 71.0 in early.




# Intro

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(knitr)
library(tidyr)
library(Hmisc)
```

```{r read, include=FALSE}
L <- read_csv("VA Lung comprehensive.csv")
C <- read_csv("VA Colon comprehensive.csv")
```

Columns I will analyze:

- PatientSex
- PatientRace
- PatientAgeCapped
- IsLate




# Colon

## Sex (n.s.)

```{r code-sex, echo=FALSE}
C_coded <- C %>% mutate(
  Sex = case_when(
    PatientSex == 1 ~ "M",
    TRUE ~ "F"
  )
)

colon_sex <- table(C_coded$Sex, C_coded$IsLate)
colon_sex %>% kable()
w_e <- colon_sex[1]
m_e <- colon_sex[2]
w_l <- colon_sex[3]
m_l <- colon_sex[4]
```
Men have `r m_l` / `r m_l + m_e` = `r m_l / (m_l + m_e) * 100` % late stage colon.

Women have `r w_l` / `r w_l + w_e` = `r w_l / (w_l + w_e) * 100` % late stage colon.

```{r test-sex, echo=FALSE}
fisher.test(colon_sex)

chi_col_s <- chisq.test(colon_sex)
chi_col_s
p_col_sex <- chi_col_s$p.value
```

## Race (significant)

```{r code-race}
C_coded_r <- C_coded %>%  # Should use this one for all analyses
  mutate(
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  )

colon_race <- table(C_coded_r$Race, C_coded_r$IsLate)
colon_race %>% kable()
```
```{r race-analy-with-summ, echo=FALSE}
C_coded_r %>%
  group_by(Race) %>%
  summarise(late_stage_rate = mean(IsLate) * 100) %>%
  kable()
```

```{r race-fisher, echo=FALSE}
fisher.test(colon_race)

chi_col_race <- chisq.test(colon_race)
chi_col_race
p_col_race <- chi_col_race$p.value
```

## Age (n.s.)

```{r plot-age, echo=FALSE}
ggplot(data = C, aes(
  PatientAgeCapped,
  fill = as.factor(IsLate),
  color = as.factor(IsLate)
  )) +
  geom_density(alpha=0.3)
```
```{r wilcox-age, echo=FALSE}
wilcox.test(
  C %>% filter(IsLate == 1) %>% pull(PatientAgeCapped),
  C %>% filter(IsLate == 0) %>% pull(PatientAgeCapped)
)
```






# Lung

```{r cleaning-coding, echo=FALSE}
L_coded <- L %>%
  mutate(
    Sex = case_when(
      PatientSex == 1 ~ "M",
      TRUE ~ "F"
    ),
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  )
```

## Sex (significant)

```{r sex, echo=FALSE}
s_table <- table(L_coded$Sex, L_coded$IsLate)
s_table %>% kable()
w_e <- s_table[1]  # note this overwrites prior vars
m_e <- s_table[2]
w_l <- s_table[3]
m_l <- s_table[4]

fisher.test(s_table)

chi_lung_sex <- chisq.test(s_table)
chi_lung_sex
p_lung_sex <- chi_lung_sex$p.value
```
Men have `r m_l` / `r m_l + m_e` = `r m_l / (m_l + m_e) * 100` late stage lung

Women have `r w_l` / `r w_l + w_e` = `r w_l / (w_l + w_e) * 100` late stage lung

## Race (significant)

```{r race, echo=FALSE}
race <- table(L_coded$Race, L_coded$IsLate)
race %>% kable()

L_coded %>%
  group_by(Race) %>%
  summarise(late_stage_rate = mean(IsLate) * 100) %>%
  kable()

fisher.test(race, workspace = 2000000/4)

chi_lung_race <- chisq.test(race)
chi_lung_race
p_lung_race <- chi_lung_race$p.value
```

## Age (significant)

```{r age-plot-lung, echo=FALSE}
ggplot(data = L, aes(
  PatientAgeCapped,
  fill = as.factor(IsLate),
  color = as.factor(IsLate))
  ) +
  geom_density(alpha=0.3)
```

```{r age-wilcox, echo=FALSE}
wilcox.test(
  L %>% filter(IsLate == 1) %>% pull(PatientAgeCapped),
  L %>% filter(IsLate == 0) %>% pull(PatientAgeCapped)
)

t.test(
  L %>% filter(IsLate == 1) %>% pull(PatientAgeCapped),
  L %>% filter(IsLate == 0) %>% pull(PatientAgeCapped)
)
```




# Appendix: Detective work on race

Colon and lung, respectively:

```{r detective, echo=FALSE, message=FALSE, warning=FALSE}
C_coded_r %>%
  group_by(Race, PatientRace) %>%
  summarise(count = n()) %>%
  arrange(PatientRace) %>%
  kable()

L_coded %>%
  group_by(Race, PatientRace) %>%
  summarise(count = n()) %>%
  arrange(PatientRace) %>%
  kable()
```



# Newest Analyses

## Assoc table

```{r big-assoc}
colon_final <- C_coded_r %>%
  mutate(cancer_type = "Colon")

lung_final <- L_coded %>%
  mutate(cancer_type = "Lung")

all_data <- bind_rows(colon_final, lung_final) %>%
  select(Sex, Race, cancer_type, PatientAgeCapped, IsLate, StageOfCancer,
         TypeOfCancer, TypeOfEmergencyEvent, EP) %>%
  mutate(IsLate = case_when(
    IsLate == 0 ~ "Early",
    IsLate == 1 ~ "Advanced",
    TRUE ~ "unknown"
  ))

assoc_table <- all_data %>%
  group_by(cancer_type, IsLate, Race) %>%
  summarise(count=n()) %>%
  pivot_wider(names_from = c(cancer_type, IsLate), values_from = count) %>%
  mutate(
    Colon_Denom = Colon_Early + Colon_Advanced,
    Lung_Denom = Lung_Early + Lung_Advanced,
    Colon_Rate = round(Colon_Advanced / Colon_Denom * 100, 1),
    Lung_Rate = round(Lung_Advanced / Lung_Denom * 100, 1),
    Factor = "Race",
    p_col_race = round(p_col_race, 4),
    p_lung_race = round(p_lung_race, 4)
  ) %>%
  rename(Level = Race) %>%
  select(
    Factor, Level,
    Colon_Advanced, Colon_Denom, Colon_Rate, p_col_race,
    Lung_Advanced, Lung_Denom, Lung_Rate, p_lung_race
  )

assoc_table %>% kable()

```



```{r comprehensive-assoc}
assoc_r <- all_data %>%
  count(cancer_type, IsLate, Race) %>%
  mutate(Factor = "Race") %>% 
  rename(Level = Race)

assoc_s <- all_data %>%
  count(cancer_type, IsLate, Sex) %>%
  mutate(Factor = "Sex") %>% 
  rename(Level = Sex)

assoc <- bind_rows(assoc_r, assoc_s) %>% 
  pivot_wider(names_from = c(cancer_type, IsLate), values_from = n) %>%
  mutate(
    Colon_Denom = Colon_Early + Colon_Advanced,
    Lung_Denom = Lung_Early + Lung_Advanced,
    Colon_Rate = round(Colon_Advanced / Colon_Denom * 100, 1),
    Lung_Rate = round(Lung_Advanced / Lung_Denom * 100, 1),
    p_colon = case_when(Factor == "Race" ~ round(p_col_race, 3), TRUE ~ round(p_col_sex, 3)),
    p_lung = case_when(Factor == "Race" ~ round(p_lung_race, 3), TRUE ~ round(p_lung_sex, 3))
  ) %>%
  select(
    Factor, Level,
    Colon_Advanced, Colon_Denom, Colon_Rate, p_colon,
    Lung_Advanced, Lung_Denom, Lung_Rate, p_lung
  )


```

```{r displayable}
assoc %>% 
  arrange(Factor, desc(Lung_Denom)) %>% 
  unite(Colon_Advanced, Colon_Denom, col="Colon_VA", sep = " / ") %>% 
  unite(Colon_VA, Colon_Rate, col="Colon_VA", sep=" (") %>% 
  unite(Lung_Advanced, Lung_Denom, col="Lung_VA", sep = " / ") %>% 
  unite(Lung_VA, Lung_Rate, col="Lung_VA", sep=" (") %>% 
  kable()
```

```{r fancy}
q123 <- list(
  q1 = ~quantile(.x, 0.25, na.rm = TRUE),
  median = ~quantile(.x, 0.5, na.rm = TRUE),
  q3 = ~quantile(.x, 0.75, na.rm = TRUE)
)

all_data %>% 
  group_by(cancer_type, IsLate) %>% 
  summarise(across(PatientAgeCapped, q123)) %>% 
  unite(PatientAgeCapped_median, PatientAgeCapped_q1, col="Median_Q1", sep = " (") %>% 
  unite(Median_Q1, PatientAgeCapped_q3, col = "Median_Q1_Q3", sep = " - ")
```


# For later

Package `Hmisc` and function `binconf()` ?


```{r ci-example, echo=TRUE}
X <- data.frame(succ = c(52,76,64,68), denom=c(90,100,96,100))

X %>% mutate(
  ciw.poi = binconf(succ, denom)[,"PointEst"],
  ciw.low = binconf(succ, denom)[,"Lower"],
  ciw.upp = binconf(succ, denom)[,"Upper"],
  
  cia.poi = binconf(succ, denom, method = "asymptotic")[,"PointEst"],
  cia.low = binconf(succ, denom, method = "asymptotic")[,"Lower"],
  cia.upp = binconf(succ, denom, method = "asymptotic")[,"Upper"],
) %>%
  kable()
```

