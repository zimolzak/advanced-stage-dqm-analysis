---
title: "Late Stage Associations"
author: "Andrew Zimolzak, MD, MMSc"
date: "`r Sys.Date()`"
output: pdf_document
---

# Intro

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(knitr)
library(tidyr)
library(Hmisc)
library(forcats)
# consider later: clean_names() from {janitor} 

knitr::opts_chunk$set(echo = FALSE)  # Sets the default to "Run but don't show code."
```

```{r version, echo=TRUE}
R.version.string

rstudioapi::versionInfo()$version

si <- sessionInfo()
for (i in 1:length(si$otherPkgs)) {
  cat(si$otherPkgs[[i]]$Package, si$otherPkgs[[i]]$Version, "\n")
}
```

```{r read, include=FALSE}

# Column setup

geis_columns <- read_csv("geis_colnames.csv")
coltype_spec <- paste0(geis_columns$type, collapse="")

# Imports

lung_raw <- read_csv("VA Lung comprehensive.csv") %>% 
  mutate(cancer_type = "Lung", site="VA")
colon_raw <- read_csv("VA Colon comprehensive.csv") %>%
  mutate(cancer_type = "Colon", site="VA")

geisinger_comprehensive <- tribble(
  ~site, ~cancer_type, ~n, ~Stage,
  "Geisinger", "Lung", 1699, "Advanced",
  "Geisinger", "Lung", 2914, "Total",
  "Geisinger", "Colon", 227, "Advanced",
  "Geisinger", "Colon", 627, "Total",
)

lung_geis_raw <- read_csv("final lung LS for Houston de-id Divvy 3-28-22.csv", col_types = coltype_spec)
  # mutate *after* assigning column names.
colon_geis_raw <- read_csv("Late Stage CRC Final DU 1-26-22.csv") %>% 
  mutate(cancer_type = "Colon", site="Geisinger")
lung_va_raw <- read_csv("VA Lung stage review deid+MM3_LC_Export_Added1OfMissing3.csv") %>% 
  mutate(cancer_type = "Lung", site="VA")
colon_va_raw <- read_csv("VA Colon stage review deid+MM3_CRC_Export.csv") %>% 
  mutate(cancer_type = "Colon", site="VA")
```

```{r tidy-comprehensive}
all_data <- bind_rows(colon_raw, lung_raw) %>%
  mutate(
    Sex = case_when(PatientSex == 1 ~ "M",TRUE ~ "F"),
    Stage = as.factor(case_when(
      IsLate == 0 ~ "Early",
      IsLate == 1 ~ "Advanced",
      TRUE ~ "unknown"
    )),
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  ) %>%
  rename(
    StageGroupNumeric = StageOfCancer,
    Age = PatientAgeCapped
  ) %>% 
  relocate(site, cancer_type, Sex, Race, Age, Stage)

colon <- all_data %>% filter(cancer_type == "Colon")
lung <- all_data %>% filter(cancer_type == "Lung")
```

```{r tidy-chart-reviews, message=FALSE}
colnames(lung_geis_raw) <- geis_columns$name

reviewed_geis_lung <- lung_geis_raw %>%
  mutate(
    cancer_type = "Lung",
    site="Geisinger",
    MOD_definite = case_when(
      MOD_present_main_outcome == "Yes" ~ TRUE,
      MOD_present_main_outcome == "No" ~ FALSE,
      MOD_present_main_outcome == "Unsure" ~ FALSE,
      TRUE ~ NA
    )
  ) %>% 
  rename(Sex = Gender) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race,  # Location,
    signal_present, cancer_dx_considered, MOD_present_main_outcome, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type
  )

reviewed_geis_colon <- colon_geis_raw %>% 
  rename(
    Age = `Age:`,
    modtext = `Is there a missed opportunity (in general) in this case?`
  ) %>% 
  mutate(
    Sex = as.factor(`Gender:`),
    Race = as.factor(case_when(
      `Ethnicity:` == "HISPANIC OR LATINO" ~ "Hispanic or Latino",
      TRUE ~ `Race:`
    )),
    Location = as.factor(`Location:`),
    signal_present = as.factor(
      `Prior to index presentation, were there any cancer signals (important/relevant findings)?`
    ),
    MOD_definite = case_when(
      modtext == "Yes" ~ TRUE,
      modtext == "No" ~ FALSE,
      modtext == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    cancer_dx_considered = as.factor(`Was a cancer diagnosis considered at the time of the earliest cancer signal?`),
    signal_date = as.Date(`When was it recorded?`),
    dx_eval_init_date = as.Date(`When was cancer-related diagnostic evaluation initiated?`),
    dx_eval_complete_date = as.Date(`When was the evaluation completed?`),
    signal_type = as.factor(`What was the earliest cancer signal recorded?`),
    .keep = "unused"
  ) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date
  )

reviewed_va_lung_colon <- lung_va_raw %>% 
  bind_rows(colon_va_raw) %>% 
  mutate(
    signal_present = as.factor(RFYesNo),
    cancer_dx_considered = as.factor(RFInitialCancerDxConsidered),
    MOD_definite = case_when(
      DxMOD == "Yes" ~ TRUE,
      DxMOD == "No" ~ FALSE,
      DxMOD == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    signal_date = as.Date(RFInitialOccDateTime),  # Sure, but these dates are all NA at present time.
    dx_eval_init_date = as.Date(RFInitialFUReqDateTime),
    dx_eval_complete_date = as.Date(RFInitialFUCompDateTime),
    signal_type = as.factor(RFInitialRF)
  ) %>% 
  relocate(
    site, cancer_type,  # Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type
  )

# FIXME - need to get all the VA date data !!

reviewed_all <- bind_rows(
    reviewed_geis_colon, reviewed_geis_lung, reviewed_va_lung_colon
  ) %>% 
  select(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date
  ) %>% 
  mutate(
    across(c(site, cancer_type), as.factor),
    Sex = fct_collapse(Sex, M = "MALE", F = "FEMALE"),
    signal_to_init = as.numeric(dx_eval_init_date - signal_date),
    init_to_completion = as.numeric(dx_eval_complete_date - dx_eval_init_date)
  )
```

## Double-check VA MOD coding/conversion

Original character in columns. New Boolean in rows.

```{r doublecheck-va}
table(reviewed_va_lung_colon$MOD_definite, reviewed_va_lung_colon$DxMOD, useNA = "ifany") %>% 
  kable()
```

## Tidying summary

List of vars that I actually analyze:

- Sex
- Stage (early/advanced)
- Race
- Age
- cancer_type
- site (VA/Geisinger)
- `MOD_present_main_outcome` $\to$ No. You should use `MOD_definite`
- `signal_present`
- `cancer_dx_considered`
- `signal_date`
- `dx_eval_init_date`
- `dx_eval_complete_date`
- `signal_type`: tidied but not (yet) used

## Dataset checklist

- Comprehensive
    - [x] `lung_raw`
    - [x] `colon_raw` (both VA comprehensive)
- Chart reviews
    - [x] `reviewed_geis_lung` (Geisinger chart review)
    - [x] `colon_geis_raw`
    - [x] `lung_va_raw`
    - [x] `colon_va_raw`

## To Do (reviewers)

- Descriptive stats (large scale)
    - flow diagram (R1 C1)
        - [x] specifically about PCP visit
    - [x] missingness R1 C1. Specifically of stage.
    - [x] demographics (by health sys)
- Manual review stats
    - description of temporal distribution
        - [ ] Ed: bin them with breaks at like 3, 6, 12 months.
    - temporal vs demographic (assoc)
    - temporal vs MOD (assoc)
    - really which reviewer wants assoc stats?
    - [x] CIs for percent of MOD (descriptive)
- [x] Geisinger data

## Might not have

- Geisinger full data (pcp)
- Geisinger non-late-stage
- VA $n = 100$ sample demographics




# Descriptives: comprehensive data

```{r definitions}
percentage_text <- function(numerator, denominator) {
  # It appears to be already vectorized.
  ntext <- as.character(numerator)
  dtext <- as.character(denominator)
  ptext <- as.character(round(numerator / denominator * 100, 1))
  final_text <- paste0(ntext, " / ", dtext, " (", ptext, "%)")
  return(final_text)
}

q123 <- list(
  q1 = ~quantile(.x, 0.25, na.rm = TRUE),
  median = ~quantile(.x, 0.5, na.rm = TRUE),
  q3 = ~quantile(.x, 0.75, na.rm = TRUE),
  mean = ~round(mean(.x, na.rm=TRUE), 2),
  sd = ~round(sd(.x, na.rm = TRUE), 2)
)
```

## VA sex, age, race

```{r va-demographics}
all_data %>%
  group_by(site, cancer_type) %>% 
  count(Sex) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent = percentage_text(n, d), .keep = "unused") %>% 
  filter(Sex == "M") %>% 
  kable()

all_data %>%
  group_by(site, cancer_type) %>% 
  count(Race) %>% 
  mutate(d = sum(n)) %>% 
  arrange(desc(cancer_type), desc(n)) %>% 
  mutate(Percent = percentage_text(n, d), .keep = "unused") %>% 
  kable()

all_data %>% 
  ggplot(aes(x=Age)) +
  geom_histogram(binwidth = 2)

all_data %>% 
  summarise(across(Age, q123)) %>% 
  kable()
```

## Table of advanced-stage percentages

```{r measure-distribution}
rbind(
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count() %>%
    mutate(Stage = "Total"),  # denominator, basically
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count(Stage)  # numerators Advanced & Early
) %>%
  filter(Stage != "Early") %>%  # just 1 numerator
  bind_rows(geisinger_comprehensive) %>% 
  arrange(desc(site), desc(cancer_type), Stage) %>% 
  pivot_wider(names_from = c(site, cancer_type, Stage), values_from = n) %>% 
  mutate(
    VA_Lung = percentage_text(VA_Lung_Advanced, VA_Lung_Total),
    VA_Colon = percentage_text(VA_Colon_Advanced, VA_Colon_Total),
    Geisinger_Lung = percentage_text(Geisinger_Lung_Advanced, Geisinger_Lung_Total),
    Geisinger_Colon = percentage_text(Geisinger_Colon_Advanced, Geisinger_Colon_Total),
    .keep = "unused"
  ) %>% 
  kable()
```

## For editor comment (PCP visit criterion/flow)

```{r pcp-stats, message=FALSE}
all_data %>%
  group_by(site, cancer_type) %>%
  summarise(
    pts=n(), pcp1=sum(HasPCPBeforeCutOff) ,pcp2=sum(HasPCPAfterCutOff),
    percent_before_cutoff=percentage_text(pcp1, pts),
    percent_after_cutoff=percentage_text(pcp2, pts)
  ) %>% 
  select(site, cancer_type, percent_before_cutoff, percent_after_cutoff) %>% 
  kable()
```

## For R1 comment (missingness)

> How did the authors deal with unknown/incomplete stage cases in cohort construction and calculation of the % advanced stage?

```{r stage-missingness-easy}
all_data %>% pull(StageGroupNumeric) %>% describe()
```

```{r stage-missingness-fancy, message=FALSE}
all_data %>%
  group_by(site, cancer_type, StageGroupNumeric) %>% 
  summarise(n = n(), n_missing = sum(is.na(StageGroupNumeric))) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent.at.stage = percentage_text(n, d), .keep = "unused") %>% 
  relocate(site, cancer_type, StageGroupNumeric, Percent.at.stage, n_missing) %>% 
  kable()
```




# Descriptives: chart review 

Purely descriptive stats of the following:

- MOD (percent)
- sex (%)
- Cancer signal preceding, %
- Cancer considered, %
- signal to workup init, histogram and quartiles
- init to complete time, histogram and quartiles
- age, histogram

```{r review-table-ci}
bind_rows(
  
  # Build up 4 "sub-tables," one for each of 4 categorical vars of interest.
  # (MOD, sex, signal, considered)
  # Each sub-table is like:
  # site, cancer_type, Fact, Val, n, d
  # VA,   Colon,       Sex,  F,   55, 100.
  
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, MOD_definite) %>% filter(!is.na(MOD_definite)) %>%
    mutate(d = sum(n), Fact = "MOD", Val=as.character(MOD_definite)) %>% select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, Sex) %>% filter(!is.na(Sex)) %>%
    mutate(d = sum(n), Fact = "Sex", Val=as.character(Sex)) %>% select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, signal_present) %>% filter(!is.na(signal_present)) %>%
    mutate(d = sum(n), Fact = "Ca signal", Val=as.character(signal_present)) %>% select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    filter(!is.na(cancer_dx_considered)) %>%
    count(site, cancer_type, cancer_dx_considered) %>%
    mutate(d = sum(n), Fact = "Ca considered", Val=as.character(cancer_dx_considered)) %>% select(site, cancer_type, Fact, Val, n, d)
  
  ) %>% 
  mutate(
    Percentage = percentage_text(n, d),
    # wilson.poi = binconf(n, d)[,"PointEst"],  # We don't need this because of percentage_text().
    wilson.low = binconf(n, d)[,"Lower"],
    wilson.upp = binconf(n, d)[,"Upper"],
    .keep = "unused"
  ) %>%
  mutate(across(starts_with("wilson"), ~ round(.x * 100, 1) )) %>% 
  unite(wilson.low, wilson.upp, col="Wilson_CI", sep = " - ") %>% 
  filter(
    # Exclude a few rows because it is redundant to say 25% true, 75% false. Just
    # mention one of these %s.
    (Fact == "MOD" & Val == TRUE) |
      (Fact == "Sex" & Val == "M") |
      (Fact == "Ca signal" & Val == "Yes") |  # Assume NA = no signal.
      (Fact == "Ca considered" & Val == "No")  # Assume Unsure = considered.
  ) %>% 
  arrange(desc(site), desc(cancer_type), Fact) %>% 
  kable()
```

\newpage

```{r descriptives-continuous-strat}
reviewed_all %>% 
  group_by(site, cancer_type) %>% 
  summarise(across(c(Age, signal_to_init, init_to_completion), q123)) %>% 
  pivot_longer(
    cols = starts_with(c("Age", "signal", "init")),
    names_to = c("variable", "statistic"),
    names_pattern = "(.*)_(.*)"
  )
```


## ONLY GEISINGER! Cancer signal to workup initiation

```{r geis-temporal, message=FALSE, warning=TRUE}

# Leave warning=TRUE for now. I want to know about "removed non-finite," etc.

temporal <- reviewed_geis_lung %>% 
  mutate(
    sig_to_init = as.numeric(dx_eval_init_date - signal_date),
    init_to_complete = as.numeric(dx_eval_complete_date - dx_eval_init_date)
  )

label(temporal$sig_to_init) <- "Time from cancer signal to workup initiation"
units(temporal$sig_to_init) <- "Day"

# FIXME - Can't figure out how to use these labels nicely in ggplot.

ggplot(temporal, aes(x=sig_to_init)) +
  geom_histogram()
```

\newpage

## ONLY GEISINGER! Workup initiation to completion

```{r i2c-descr, message=FALSE}
ggplot(temporal, aes(x=init_to_complete)) +
  geom_histogram()
```

## ONLY GEISINGER! Age

```{r age-descr, message=FALSE}
ggplot(temporal, aes(x=Age)) +
  geom_histogram()
```

## ONLY GEISINGER! Table of quartiles (temporal variables)

```{r temporal-descr}
temporal %>% 
  summarise(across(sig_to_init:init_to_complete, q123)) %>% 
  select(!contains(c("mean", "sd"))) %>% 
  unite(sig_to_init_median, sig_to_init_q1, col="sig_to_init", sep=" (") %>% 
  unite(sig_to_init, sig_to_init_q3, col="sig_to_init", sep=" - ") %>% 
  unite(init_to_complete_median, init_to_complete_q1, col="init_to_complete", sep=" (") %>% 
  unite(init_to_complete, init_to_complete_q3, col="init_to_complete", sep=" - ") %>% 
  mutate(across(contains("to"), ~ paste0(.x, ")"))) %>% 
  kable()
```

\newpage




# Associations: comprehensive data

## Colon stage/age plot

```{r test-colon-sex, echo=TRUE}
tab_colon_sex <- table(colon$Sex, colon$Stage)

fisher.test(tab_colon_sex)

chi_colon_sex <- chisq.test(tab_colon_sex)
chi_colon_sex
p_colon_sex <- chi_colon_sex$p.value
```

```{r test-colon-race, include=FALSE}
tab_colon_race <- table(colon$Race, colon$Stage)

fisher.test(tab_colon_race)

chi_colon_race <- chisq.test(tab_colon_race)
chi_colon_race
p_colon_race <- chi_colon_race$p.value
```

```{r plot-colon-age, message=FALSE, warning=FALSE}
ggplot(
  data = colon,
  aes(
    Age,
    fill = Stage,
    color = Stage
  )
) +
  geom_density(alpha=0.3) +
  xlim(20, 100)

ggplot(data = colon, aes(Age)) +
  geom_histogram() +
  facet_grid(rows="Stage") +
  xlim(20, 100)
```

```{r test-colon-age, echo=TRUE}
wilc_colon_age <- wilcox.test(
  colon %>% filter(Stage == "Advanced") %>% pull(Age),
  colon %>% filter(Stage == "Early") %>% pull(Age)
)

wilc_colon_age
p_colon_age <- wilc_colon_age$p.value
```

## Lung stage/age plot

```{r test-lung-sex, include=FALSE}
tab_lung_sex <- table(lung$Sex, lung$Stage)

fisher.test(tab_lung_sex)

chi_lung_sex <- chisq.test(tab_lung_sex)
chi_lung_sex
p_lung_sex <- chi_lung_sex$p.value
```

```{r test-lung-race, include=FALSE}
tab_lung_race <- table(lung$Race, lung$Stage)

fisher.test(tab_lung_race, workspace = 2000000/4)

chi_lung_race <- chisq.test(tab_lung_race)
chi_lung_race
p_lung_race <- chi_lung_race$p.value
```

```{r plot-lung-age, message=FALSE, warning=FALSE}
ggplot(
  data = lung,
  aes(
    Age,
    fill = Stage,
    color = Stage
  )
) +
  geom_density(alpha=0.3) +
  xlim(20, 100)

ggplot(data = lung, aes(Age)) +
  geom_histogram() +
  facet_grid(rows="Stage") +
  xlim(20, 100)
```

```{r test-lung-age, include=FALSE}
wilc_lung_age <- wilcox.test(
  lung %>% filter(Stage == "Advanced") %>% pull(Age),
  lung %>% filter(Stage == "Early") %>% pull(Age)
)

wilc_lung_age
p_lung_age <- wilc_lung_age$p.value

t.test(
  lung %>% filter(Stage == "Advanced") %>% pull(Age),
  lung %>% filter(Stage == "Early") %>% pull(Age)
)
```

## Table: Advanced stage percentages, by demographics

```{r categorical-assoc}
assoc_r <- all_data %>%
  count(cancer_type, Stage, Race) %>%
  mutate(Factor = "Race") %>% 
  rename(Level = Race)

assoc_s <- all_data %>%
  count(cancer_type, Stage, Sex) %>%
  mutate(Factor = "Sex") %>% 
  rename(Level = Sex)

assoc <- bind_rows(assoc_r, assoc_s) %>% 
  pivot_wider(names_from = c(cancer_type, Stage), values_from = n) %>%
  mutate(
    Colon_Denom = Colon_Early + Colon_Advanced,
    Lung_Denom = Lung_Early + Lung_Advanced,
    Colon_Rate = round(Colon_Advanced / Colon_Denom * 100, 1),
    Lung_Rate = round(Lung_Advanced / Lung_Denom * 100, 1),
    p_colon = case_when(Factor == "Race" ~ round(p_colon_race, 3), Factor == "Sex" ~ round(p_colon_sex, 3)),
    p_lung = case_when(Factor == "Race" ~ round(p_lung_race, 3), Factor == "Sex" ~ round(p_lung_sex, 3))
  ) %>%
  select(
    Factor, Level,
    Colon_Advanced, Colon_Denom, Colon_Rate, p_colon,
    Lung_Advanced, Lung_Denom, Lung_Rate, p_lung
  )
```

```{r displayable}
assoc %>% 
  arrange(Factor, desc(Lung_Denom)) %>% 
  unite(Colon_Advanced, Colon_Denom, col="Colon_VA", sep = " / ") %>% 
  unite(Colon_VA, Colon_Rate, col="Colon_VA", sep=" (") %>% 
  unite(Lung_Advanced, Lung_Denom, col="Lung_VA", sep = " / ") %>% 
  unite(Lung_VA, Lung_Rate, col="Lung_VA", sep=" (") %>% 
  mutate(across(c(Colon_VA, Lung_VA), ~ paste0(.x, ")"))) %>%   # neat trick to add close paren
  kable()
```

## Table: Age, by cancer type and advanced-stage status

```{r age-assoc, message=FALSE}
all_data %>% 
  group_by(cancer_type, Stage) %>% 
  summarise(across(Age, q123)) %>% 
  unite(Age_median, Age_q1, col="Median_Q1", sep = " (") %>% 
  unite(Median_Q1, Age_q3, col = "Median_Q1_Q3", sep = " - ") %>% 
  unite(Age_mean, Age_sd, col="Mean_SD", sep = " (") %>% 
  mutate(across(c(Median_Q1_Q3, Mean_SD), ~ paste0(.x, ")"))) %>% 
  mutate(P_value = case_when(
    cancer_type == "Colon" ~ round(p_colon_age, 3),
    TRUE ~ p_lung_age
  )) %>% 
  kable()
```




# ONLY GEISINGER! Associations: chart review

## Initiation time vs. gender plot

```{r init-gender, message=FALSE, warning=TRUE}
ggplot(data = temporal, aes(sig_to_init)) +
  geom_histogram() +
  facet_grid(rows="Sex")

wilc_s2i_gender <- wilcox.test(
  temporal %>% filter(Sex == "M") %>% pull(sig_to_init),
  temporal %>% filter(Sex == "F") %>% pull(sig_to_init)
)
wilc_s2i_gender
p_init_gender <- wilc_s2i_gender$p.value
```

\newpage

## Completion time vs. gender plot

```{r completion-gender}
ggplot(data = temporal, aes(init_to_complete)) +
  geom_histogram() +
  facet_grid(rows="Sex")

wilc_i2c_gender <- wilcox.test(
  temporal %>% filter(Sex == "M") %>% pull(init_to_complete),
  temporal %>% filter(Sex == "F") %>% pull(init_to_complete)
)
wilc_i2c_gender
p_completion_gender <- wilc_i2c_gender$p.value
```

## Table: Time intervals vs. gender

```{r time-gender-table}
pval_row <- tribble(
  ~Sex, ~sig_to_init, ~init_to_complete,
  "P value", as.character(round(p_init_gender, 3)), as.character(round(p_completion_gender, 3))
)

temporal %>% 
  group_by(Sex) %>% 
  summarise(across(sig_to_init:init_to_complete, q123)) %>% 
  select(!contains(c("mean", "sd"))) %>% 
  unite(sig_to_init_median, sig_to_init_q1, col="sig_to_init", sep=" (") %>% 
  unite(sig_to_init, sig_to_init_q3, col="sig_to_init", sep=" - ") %>% 
  unite(init_to_complete_median, init_to_complete_q1, col="init_to_complete", sep=" (") %>% 
  unite(init_to_complete, init_to_complete_q3, col="init_to_complete", sep=" - ") %>% 
  mutate(across(contains("to"), ~ paste0(.x, ")"))) %>% 
  bind_rows(pval_row) %>% 
  kable()
```

\newpage

## Initiation time vs. age plot

```{r helper-fns}
p <- function(spear){
  return(round(spear$p.value, 3))
}

r <- function(spear){
  return(round(spear$estimate, 3))
}
```

```{r ia}
sp_ia <- cor.test(temporal$Age, temporal$sig_to_init, method = "spearman")
```

$P = `r p(sp_ia)`$

$\rho = `r r(sp_ia)`$

```{r init-vs-age-plot}
ggplot(temporal, aes(x=Age, y=sig_to_init)) +
  geom_jitter(alpha=0.5) +
  scale_y_log10()
```

\newpage

## Completion time vs. age (multiple plots)

```{r ca}
sp_ca <- cor.test(temporal$Age, temporal$init_to_complete, method = "spearman")  # stat significant
```

$P = `r p(sp_ca)`$

$\rho = `r r(sp_ca)`$

```{r completion-age-plot}
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  xlim(40, 90) +
  scale_y_log10()
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_bin_2d(bins=10) +
  coord_cartesian(xlim=c(40,90)) +
  scale_y_continuous(breaks = seq(0,6000, 365*2))
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  coord_cartesian(xlim=c(40,90), ylim=c(-10, 600)) +   # probably always use coord_ with _smooth
  scale_y_continuous(breaks = seq(0,6000, 365), minor_breaks = seq(0, 6000, 365/12))
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  coord_cartesian(xlim=c(40,90), ylim=c(-10, 120)) +
  scale_y_continuous(breaks = seq(0,6000, 30), minor_breaks = seq(0, 6000, 30/4))
```

\newpage

## Initiation time vs. completion time (plots are too wacky)

```{r ic}
sp_ic <- cor.test(temporal$sig_to_init, temporal$init_to_complete, method = "spearman")  # stat significant
```

$P = `r p(sp_ic)`$

$\rho = `r r(sp_ic)`$

```{r init-completion-plot}
ggplot(temporal, aes(x=sig_to_init, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  scale_y_log10() + scale_x_log10()
ggplot(temporal, aes(x=sig_to_init, y=init_to_complete)) +
  geom_hex(bins=10) +
  scale_y_log10() + scale_x_log10()
ggplot(temporal, aes(x=sig_to_init + 0.1, y=init_to_complete + 0.1)) +
  geom_density_2d() + geom_jitter(alpha=0.5) +
  scale_y_log10() + scale_x_log10()
ggplot(temporal, aes(x=sig_to_init, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  coord_cartesian( xlim=c(0, 365*2), ylim=c(0,1200))+
  scale_x_continuous(breaks = seq(0,2000,365)) +
  scale_y_continuous(breaks = seq(0,2000,365))
```
