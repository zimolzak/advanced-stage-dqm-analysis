---
title: "Late Stage Associations"
author: "Andrew Zimolzak"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
```

```{r read}
L <- read_csv("VA Lung comprehensive.csv")
C <- read_csv("VA Colon comprehensive.csv")

```

Useful columns:
- PatientSex
- PatientRace
- PatientAgeCapped
- IsLate

# Colon

```{r code-sex}
C_coded <- C %>% mutate(
  Sex = case_when(
    PatientSex == 1 ~ "M",
    TRUE ~ "F"
  )
)


colon_sex <- table(C_coded$Sex, C_coded$IsLate)
colon_sex
w_e <- colon_sex[1]
m_e <- colon_sex[2]
w_l <- colon_sex[3]
m_l <- colon_sex[4]
```
Men have `r m_l` / `r m_l + m_e` = `r m_l / (m_l + m_e) * 100` late stage colon.

Women have `r w_l` / `r w_l + w_e` = `r w_l / (w_l + w_e) * 100` late stage colon.

```{r fisher-test-sex}
fisher.test(colon_sex)
```

```{r code-race}
C_coded_r <- C_coded %>%
  mutate(
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  )

colon_race <- table(C_coded_r$Race, C_coded_r$IsLate)
colon_race
```
```{r race-analy-with-summ}
C_coded_r %>%
  group_by(Race) %>%
  summarise(late_stage_rate = mean(IsLate) * 100)
```

```{r race-fisher}
fisher.test(colon_race)
```


```{r plot-age}
ggplot(data = C, aes(PatientAgeCapped, fill = as.factor(IsLate))) +
  geom_density()
```
```{r wilcox-age}
wilcox.test(
  C %>% filter(IsLate == 1) %>% pull(PatientAgeCapped),
  C %>% filter(IsLate == 0) %>% pull(PatientAgeCapped)
)
```

## Findings

**Higher in white and other than in Black or Hispanic** 34.1% versus 30.8%.





# Lung

```{r cleaning-coding}
L_coded <- L %>%
  mutate(
    Sex = case_when(
      PatientSex == 1 ~ "M",
      TRUE ~ "F"
    ),
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  )
```


```{r sex}
s_table <- table(L_coded$Sex, L_coded$IsLate)
s_table
w_e <- s_table[1]  # note this overwrites prior vars
m_e <- s_table[2]
w_l <- s_table[3]
m_l <- s_table[4]

fisher.test(s_table)
```
Men have `r m_l` / `r m_l + m_e` = `r m_l / (m_l + m_e) * 100` late stage lung

Women have `r w_l` / `r w_l + w_e` = `r w_l / (w_l + w_e) * 100` late stage lung


```{r race}
race <- table(L_coded$Race, L_coded$IsLate)
race

L_coded %>%
  group_by(Race) %>%
  summarise(late_stage_rate = mean(IsLate) * 100)

fisher.test(race, workspace = 2000000/4)

chisq.test(race)

```

```{r age-plot}

```

```{r age-wilcox}

```

## Findings (lung)

- Sex is predictive, 46.2% vs 42.7% in women.
- Race is significant. 48.2% black vs 45.7% white


# Detective work on race

```{r detective}
C_coded_r %>%
  group_by(Race, PatientRace) %>%
  summarise(count = n()) %>%
  arrange(PatientRace)

L_coded %>%
  group_by(Race, PatientRace) %>%
  summarise(count = n()) %>%
  arrange(PatientRace)

```

