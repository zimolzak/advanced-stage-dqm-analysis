---
title: "Late Stage Associations"
author: "Andrew Zimolzak, MD, MMSc"
date: "`r Sys.Date()`"
output: pdf_document
---

# To Do

## My list: data and analyses

- Comprehensive data
    - [x] `lung_raw`
    - [x] `colon_raw` (both VA comprehensive)
- Chart review data
    - [x] `reviewed_geis_lung` (Geisinger chart review)
    - [x] `colon_geis_raw`
    - [x] `lung_va_raw`
    - [x] `colon_va_raw`
    - [x] VA date data (re-export?)
    - [ ] ...and sex, and age.
- Analyses
    - [x] Oh dear, what if "date of completion" varies by reviewer.
    - [ ] All the fix comments, related to Spearman's $\rho$ handling `NA` values, and stratifying by site and cancer type.

## Reviewers' list

- Descriptive stats (large scale)
    - flow diagram (R1 C1)
        - [x] specifically about PCP visit
    - [x] missingness R1 C1. Specifically of stage.
    - [x] demographics (by health sys)
- Manual review stats
    - description of temporal distribution
        - [ ] Ed: bin them with breaks at like 3, 6, 12 months.
    - temporal vs demographic (assoc)
    - temporal vs MOD (assoc)
    - really which reviewer wants assoc stats?
    - [x] CIs for percent of MOD (descriptive)
- [x] Geisinger data




# Intro

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(knitr)
library(tidyr)
library(Hmisc)
library(forcats)
# consider later: clean_names() from {janitor} 

knitr::opts_chunk$set(echo = FALSE)  # Sets the default to "Run but don't show code."
```

## Versions

```{r version, echo=TRUE}
R.version.string

rstudioapi::versionInfo()$version

si <- sessionInfo()
for (i in 1:length(si$otherPkgs)) {
  cat(si$otherPkgs[[i]]$Package, si$otherPkgs[[i]]$Version, "\n")
}
```




# Import and tidy

```{r read, include=FALSE}

# Column setup (only for Geisinger Lung)

geis_columns <- read_csv("geis_colnames.csv")
coltype_spec <- paste0(geis_columns$type, collapse="")

# Imports

lung_raw <- read_csv("VA Lung comprehensive.csv") %>% 
  mutate(cancer_type = "Lung", site="VA")
colon_raw <- read_csv("VA Colon comprehensive.csv") %>%
  mutate(cancer_type = "Colon", site="VA")

geisinger_comprehensive <- tribble(
  ~site, ~cancer_type, ~n, ~Stage,
  "Geisinger", "Lung", 1699, "Advanced",
  "Geisinger", "Lung", 2914, "Total",
  "Geisinger", "Colon", 227, "Advanced",
  "Geisinger", "Colon", 627, "Total",
)

lung_geis_raw <- read_csv("final lung LS for Houston de-id Divvy 3-28-22.csv", col_types = coltype_spec)
  # mutate *after* assigning column names.
colon_geis_raw <- read_csv("Late Stage CRC Final DU 1-26-22.csv") %>% 
  mutate(cancer_type = "Colon", site="Geisinger")

# NOTE - there were garbage rows at the bottom of these ones marked "OLD"

lung_va_raw_OLD <- read_csv("VA Lung stage review deid+MM3_LC_Export_Added1OfMissing3.csv") %>% 
  mutate(cancer_type = "Lung", site="VA")
colon_va_raw_OLD <- read_csv("VA Colon stage review deid+MM3_CRC_Export.csv") %>% 
  mutate(cancer_type = "Colon", site="VA")

lung_va_raw <- read_csv("deid-again-2025-01/deid+MM3_LC_Export_Added1OfMissing3.csv") %>% 
  mutate(cancer_type = "Lung", site="VA")

colon_va_raw <- read_csv("deid-again-2025-01/deid+MM3_CRC_Export.csv") %>% 
  mutate(cancer_type = "Colon", site="VA") %>% 
  filter(!is.na(CancerStage)) %>% 
# IMPORTANT - filtered out garbage rows at end (leftover of Excel export)
  rename(siginit = `siginit-neg-never`)

```

```{r tidy-comprehensive}
all_data <- bind_rows(colon_raw, lung_raw) %>%
  mutate(
    Sex = case_when(PatientSex == 1 ~ "M",TRUE ~ "F"),
    Stage = as.factor(case_when(
      IsLate == 0 ~ "Early",
      IsLate == 1 ~ "Advanced",
      TRUE ~ "unknown"
    )),
    Race = case_when(
      PatientRace == 3 ~ "White",
      PatientRace == 1 ~ "Black",
      PatientRace == 2 ~ "Hispanic",
      TRUE ~ "Other"
    )
  ) %>%
  rename(
    StageGroupNumeric = StageOfCancer,
    Age = PatientAgeCapped
  ) %>% 
  relocate(site, cancer_type, Sex, Race, Age, Stage)

colon <- all_data %>% filter(cancer_type == "Colon")
lung <- all_data %>% filter(cancer_type == "Lung")

# yes, we kind of use these later.
# under "Associations: comprehensive data"
# FIXME_maybe - do it as group_by in future.
```

```{r dim-col-comprehensive, echo=TRUE}
dim(all_data)
colnames(all_data)
```

```{r tidy-chart-reviews, message=FALSE}
colnames(lung_geis_raw) <- geis_columns$name

yr_offset <- 365.25 * (2016 - 1970)  # to generate fake VA dates

reviewed_geis_lung <- lung_geis_raw %>%
  mutate(
    cancer_type = "Lung",
    site="Geisinger",
    MOD_definite = case_when(
      MOD_present_main_outcome == "Yes" ~ TRUE,
      MOD_present_main_outcome == "No" ~ FALSE,
      MOD_present_main_outcome == "Unsure" ~ FALSE,
      TRUE ~ NA
    )
  ) %>% 
  rename(Sex = Gender) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race,  # Location,
    signal_present, cancer_dx_considered, MOD_present_main_outcome, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type
  )

reviewed_geis_colon <- colon_geis_raw %>% 
  rename(
    Age = `Age:`,
    modtext = `Is there a missed opportunity (in general) in this case?`
  ) %>% 
  mutate(
    Sex = as.factor(`Gender:`),
    Race = as.factor(case_when(
      `Ethnicity:` == "HISPANIC OR LATINO" ~ "Hispanic or Latino",
      TRUE ~ `Race:`
    )),
    Location = as.factor(`Location:`),
    signal_present = as.factor(
      `Prior to index presentation, were there any cancer signals (important/relevant findings)?`
    ),
    MOD_definite = case_when(
      modtext == "Yes" ~ TRUE,
      modtext == "No" ~ FALSE,
      modtext == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    cancer_dx_considered = as.factor(`Was a cancer diagnosis considered at the time of the earliest cancer signal?`),
    signal_date = as.Date(`When was it recorded?`),
    dx_eval_init_date = as.Date(`When was cancer-related diagnostic evaluation initiated?`),
    dx_eval_complete_date = as.Date(`When was the evaluation completed?`),
    signal_type = as.factor(`What was the earliest cancer signal recorded?`),
    .keep = "unused"
  ) %>% 
  relocate(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date
  )

reviewed_va_lung_colon <- lung_va_raw %>% 
  bind_rows(colon_va_raw) %>% 
  mutate(
    siginit = case_when(
      siginit < -40000 ~ NA,
      .default = siginit
    ),
    initcomp = case_when(
      initcomp < -40000 ~ NA,
      .default = initcomp
    ),
    signal_present = as.factor(RFYesNo),
    cancer_dx_considered = as.factor(RFInitialCancerDxConsidered),
    MOD_definite = case_when(
      DxMOD == "Yes" ~ TRUE,
      DxMOD == "No" ~ FALSE,
      DxMOD == "Unsure" ~ FALSE,
      TRUE ~ NA
    ),
    signal_date = as.Date(yr_offset),
    dx_eval_init_date = as.Date(siginit + yr_offset),
    dx_eval_complete_date = as.Date(siginit + initcomp + yr_offset),
    signal_type = as.factor(RFInitialRF)
  ) %>% 
  relocate(
    site, cancer_type,  # Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date, signal_type,
    siginit, initcomp
  )

# IMPORTANT list of kept variables below.

reviewed_all <- bind_rows(
    reviewed_geis_colon, reviewed_geis_lung, reviewed_va_lung_colon
  ) %>% 
  select(
    site, cancer_type, Age, Sex, Race, Location,
    signal_present, cancer_dx_considered, MOD_definite,
    signal_date, dx_eval_init_date, dx_eval_complete_date,
    Reviewer
  ) %>% 
  mutate(
    across(c(site, cancer_type), as.factor),
    Sex = fct_collapse(Sex, M = "MALE", F = "FEMALE"),
    
    # NOTE the different naming "signal" vs "sig", and "completion" vs "complete"
    
    signal_to_init = as.numeric(dx_eval_init_date - signal_date),
    init_to_completion = as.numeric(dx_eval_complete_date - dx_eval_init_date),
    signal_to_completion = as.numeric(dx_eval_complete_date - signal_date)
  )
```

```{r dim-col-reviews, echo=TRUE}
dim(reviewed_all)
colnames(reviewed_all)
```

## Double-checking VA MOD coding/conversion

Original character in columns. New Boolean in rows.

```{r doublecheck-va}
table(reviewed_va_lung_colon$MOD_definite, reviewed_va_lung_colon$DxMOD, useNA = "ifany") %>% 
  kable()
```

## Tidying summary

List of vars that I actually analyze:

- Sex
- Stage (early/advanced)
- Race
- Age
- cancer_type
- site (VA/Geisinger)
- `MOD_present_main_outcome` $\to$ No. You should use `MOD_definite`
- `signal_present`
- `cancer_dx_considered`
- `signal_date`
- `dx_eval_init_date`
- `dx_eval_complete_date`
- `signal_type`: tidied but not (yet) used

Might not have:

- Geisinger full data (to see about PCP exclusion)
- Geisinger non-late-stage
- VA $n = 100$ sample demographics




# Descriptives: comprehensive data

```{r definitions}
percentage_text <- function(numerator, denominator) {
  # It appears to be already vectorized.
  ntext <- as.character(numerator)
  dtext <- as.character(denominator)
  ptext <- as.character(round(numerator / denominator * 100, 1))
  final_text <- paste0(ntext, " / ", dtext, " (", ptext, "%)")
  return(final_text)
}

q123ms <- list(
  q1 = ~quantile(.x, 0.25, na.rm = TRUE),
  median = ~quantile(.x, 0.5, na.rm = TRUE),
  q3 = ~quantile(.x, 0.75, na.rm = TRUE),
  mean = ~round(mean(.x, na.rm=TRUE), 2),
  sd = ~round(sd(.x, na.rm = TRUE), 2)
)
```

## VA sex, age, race

```{r va-demographics}
all_data %>%
  group_by(site, cancer_type) %>% 
  count(Sex) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent = percentage_text(n, d), .keep = "unused") %>% 
  filter(Sex == "M") %>% 
  kable()

all_data %>%
  group_by(site, cancer_type) %>% 
  count(Race) %>% 
  mutate(d = sum(n)) %>% 
  arrange(desc(cancer_type), desc(n)) %>% 
  mutate(Percent = percentage_text(n, d), .keep = "unused") %>% 
  kable()

all_data %>% 
  ggplot(aes(x=Age)) +
  geom_histogram(binwidth = 2)

all_data %>% 
  summarise(across(Age, q123ms)) %>% 
  kable()
```

## Table of advanced-stage percentages

```{r measure-distribution}
rbind(  # FIXME_maybe - should we use bind_rows() ?
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count() %>%
    mutate(Stage = "Total"),  # denominator, basically
  all_data %>% 
    group_by(site, cancer_type) %>% 
    count(Stage)  # numerators Advanced & Early
) %>%
  filter(Stage != "Early") %>%  # just 1 numerator
  bind_rows(geisinger_comprehensive) %>% 
  arrange(desc(site), desc(cancer_type), Stage) %>% 
  pivot_wider(names_from = c(site, cancer_type, Stage), values_from = n) %>% 
  mutate(
    VA_Lung = percentage_text(VA_Lung_Advanced, VA_Lung_Total),
    VA_Colon = percentage_text(VA_Colon_Advanced, VA_Colon_Total),
    Geisinger_Lung = percentage_text(Geisinger_Lung_Advanced, Geisinger_Lung_Total),
    Geisinger_Colon = percentage_text(Geisinger_Colon_Advanced, Geisinger_Colon_Total),
    .keep = "unused"
  ) %>% 
  kable()
```

## For editor comment (PCP visit criterion/flow)

```{r pcp-stats, message=FALSE}
all_data %>%
  group_by(site, cancer_type) %>%
  summarise(
    pts=n(), pcp1=sum(HasPCPBeforeCutOff) ,pcp2=sum(HasPCPAfterCutOff),
    percent_before_cutoff=percentage_text(pcp1, pts),
    percent_after_cutoff=percentage_text(pcp2, pts)
  ) %>% 
  select(site, cancer_type, percent_before_cutoff, percent_after_cutoff) %>% 
  kable()
```

## For R1 comment (missingness)

> How did the authors deal with unknown/incomplete stage cases in cohort construction and calculation of the % advanced stage?

```{r stage-missingness-easy}
all_data %>% pull(StageGroupNumeric) %>% describe()
```

```{r stage-missingness-fancy, message=FALSE}
all_data %>%
  group_by(site, cancer_type, StageGroupNumeric) %>% 
  summarise(n = n(), n_missing = sum(is.na(StageGroupNumeric))) %>% 
  mutate(d = sum(n)) %>% 
  mutate(Percent.at.stage = percentage_text(n, d), .keep = "unused") %>% 
  relocate(site, cancer_type, StageGroupNumeric, Percent.at.stage, n_missing) %>% 
  kable()
```




# Descriptives: chart review 

Purely descriptive stats of the following:

- MOD (percent)
- sex (%)
- Cancer signal preceding, %
- Cancer considered, %
- signal to workup init, histogram and quartiles
- init to complete time, histogram and quartiles
- age, histogram

```{r review-table-ci}
bind_rows(
  
  # Build up 4 "sub-tables," one for each of 4 categorical vars of interest.
  # (MOD, sex, signal, considered)
  # Each sub-table is like:
  # site, cancer_type, Fact, Val, n, d
  # VA,   Colon,       Sex,  F,   55, 100.
  
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, MOD_definite) %>% filter(!is.na(MOD_definite)) %>%
    mutate(d = sum(n), Fact = "MOD", Val=as.character(MOD_definite)) %>% select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, Sex) %>% filter(!is.na(Sex)) %>%
    mutate(d = sum(n), Fact = "Sex", Val=as.character(Sex)) %>% select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    count(site, cancer_type, signal_present) %>% filter(!is.na(signal_present)) %>%
    mutate(d = sum(n), Fact = "Ca signal", Val=as.character(signal_present)) %>% select(site, cancer_type, Fact, Val, n, d),
  reviewed_all %>% group_by(site, cancer_type) %>% 
    filter(!is.na(cancer_dx_considered)) %>%
    count(site, cancer_type, cancer_dx_considered) %>%
    mutate(d = sum(n), Fact = "Ca considered", Val=as.character(cancer_dx_considered)) %>% select(site, cancer_type, Fact, Val, n, d)
  
  ) %>% 
  mutate(
    Percentage = percentage_text(n, d),
    # wilson.poi = binconf(n, d)[,"PointEst"],  # We don't need this because of percentage_text().
    wilson.low = binconf(n, d)[,"Lower"],
    wilson.upp = binconf(n, d)[,"Upper"],
    .keep = "unused"
  ) %>%
  mutate(across(starts_with("wilson"), ~ round(.x * 100, 1) )) %>% 
  unite(wilson.low, wilson.upp, col="Wilson_CI", sep = " - ") %>% 
  filter(
    # Exclude a few rows because it is redundant to say 25% true, 75% false. Just
    # mention one of these %s.
    (Fact == "MOD" & Val == TRUE) |
      (Fact == "Sex" & Val == "M") |
      (Fact == "Ca signal" & Val == "Yes") |  # Assume NA = no signal.
      (Fact == "Ca considered" & Val == "No")  # Assume Unsure = considered.
  ) %>% 
  arrange(desc(site), desc(cancer_type), Fact) %>% 
  kable()
```

\newpage




```{r functions-continuous-vars}
median_text_scalar <- function(m, q1, q3){
  vec <- c(
    as.character(round(m, 1)),
    " (",
    as.character(round(q1, 1)),
    " - ",
    as.character(round(q3, 1)),
    ")"
  )
  return(paste0(vec, collapse = ""))
}

mean_text_scalar <- function(m, s){
  vec <- c(
    as.character(round(m, 1)),
    " (",
    as.character(round(s, 1)),
    ")"
  )
  return(paste0(vec, collapse = ""))
}

median_text <- Vectorize(median_text_scalar)
mean_text <- Vectorize(mean_text_scalar)

```

```{r table-descriptives-continuous-strat, message=FALSE}

reviewed_all %>% 
  group_by(site, cancer_type) %>% 
  summarise(across(c(Age, signal_to_init, init_to_completion, signal_to_completion), q123ms)) %>% 
  pivot_longer(
    cols = starts_with(c("Age", "signal", "init")),
    names_to = c("variable", "statistic"),
    names_pattern = "(.*)_(.*)"
  ) %>%
  filter(statistic!="mean", statistic!="sd") %>% 
  pivot_wider(names_from = statistic, values_from = value) %>% 
  # mutate(across(c(q1, median, q3, mean, sd), ~ round(.x, 1))) %>% 
  mutate(
    median_q1_q3 = median_text(median, q1, q3),
    # mean_sd = mean_text(mean, sd),
    .keep = "unused"
  ) %>% 
  pivot_wider(
    names_from = c(site, cancer_type),
    values_from = median_q1_q3
  ) %>% 
  relocate(variable, VA_Lung, VA_Colon, Geisinger_Lung, Geisinger_Colon) %>% 
  kable()
```

```{r constants}
yearly = seq(0, 6000, 365)
monthly = seq(0, 6000, 365/12)
quarterly = seq(0, 6000, 365/4)
THREE_MONTHS = 365 / 4

year_breaks_custom <- c(c(0, 0.25, 0.5), seq(1, 17, 1))
day_breaks_custom <- year_breaks_custom * 365

```


```{r fig-binning-custom-histo}

reviewed_all %>% 
  ggplot(aes(x=signal_to_completion)) +
  geom_histogram(breaks = day_breaks_custom) +
  scale_x_continuous(breaks=seq(0, 6000, 365*2))


```




## Plots for all sites/cancers

```{r descrip-facet-age, warning=FALSE}
ggplot(reviewed_all, aes(x=Age)) +
  geom_histogram(binwidth = 2) +
  facet_grid(vars(site, cancer_type))
```

```{r descrip-facet-s2i, warning=FALSE}
ggplot(reviewed_all, aes(x=signal_to_init)) +
  geom_histogram(bins=30) +
  facet_grid(vars(site, cancer_type))
```


```{r descrip-facet-i2c, warning=FALSE}
ggplot(reviewed_all, aes(x=init_to_completion)) +
  geom_histogram(bins=30) +
  facet_grid(vars(site, cancer_type))
```

### Binning

We are trying to show the...

> temporal distribution of MODs, with regard to diagnosis (i.e. how many occurred <3 months prior to appropriate evaluation/diagnosis, vs 3–6 months, 6–12 mos, etc)....


```{r constants-ed}
year_breaks_ed <- c(0, 0.25, 0.5, 1, 2, 3 ,4, 20)
month_breaks_ed <- year_breaks_ed * 12
day_breaks_ed <- year_breaks_ed * 365

```


```{r s2c-plot, warning=FALSE}


reviewed_all %>% 
  filter(MOD_definite == TRUE) %>% 
  mutate(
    signal_to_completion = case_when(
      signal_to_completion > 730 ~ 730,
      .default = signal_to_completion
    )
  ) %>% 
ggplot(aes(x=signal_to_completion)) +
  geom_histogram(binwidth = THREE_MONTHS) +
  facet_grid(vars(site, cancer_type)) +
  coord_cartesian(xlim=c(0,365*2)) +
  scale_x_continuous(breaks = yearly, minor_breaks = quarterly) +
  labs(title="Limited to MOD only, and capped at 2 y")

```

```{r table-binning}

reviewed_all %>% 
  filter(MOD_definite == TRUE) %>% 
  mutate(
    months = signal_to_completion /  (365 / 12),
    
    signal_to_completion_months = cut(months, breaks=month_breaks_ed),
    .before = everything()
  ) %>% 
  group_by(site, cancer_type) %>% 
  count(signal_to_completion_months, .drop = FALSE) %>% 
  mutate(s = sum(n), Percent = percentage_text(n, s), .before = everything()) %>% 
  select(site, cancer_type, Percent, signal_to_completion_months) %>% 
  pivot_wider(id_cols = signal_to_completion_months, names_from = c(site, cancer_type), values_from = Percent) %>% 
  kable()

```




\newpage




# Associations: comprehensive data

## Colon stage/age plot

```{r test-colon-sex, echo=TRUE}
tab_colon_sex <- table(colon$Sex, colon$Stage)

fisher.test(tab_colon_sex)

chi_colon_sex <- chisq.test(tab_colon_sex)
chi_colon_sex
p_colon_sex <- chi_colon_sex$p.value
```

```{r test-colon-race, include=FALSE}
tab_colon_race <- table(colon$Race, colon$Stage)

fisher.test(tab_colon_race)

chi_colon_race <- chisq.test(tab_colon_race)
chi_colon_race
p_colon_race <- chi_colon_race$p.value
```

```{r plot-colon-age, message=FALSE, warning=FALSE}
ggplot(
  data = colon,
  aes(
    Age,
    fill = Stage,
    color = Stage
  )
) +
  geom_density(alpha=0.3) +
  xlim(20, 100)

ggplot(data = colon, aes(Age)) +
  geom_histogram() +
  facet_grid(rows="Stage") +
  xlim(20, 100)
```

```{r test-colon-age, echo=TRUE}
wilc_colon_age <- wilcox.test(
  colon %>% filter(Stage == "Advanced") %>% pull(Age),
  colon %>% filter(Stage == "Early") %>% pull(Age)
)

wilc_colon_age
p_colon_age <- wilc_colon_age$p.value
```

## Lung stage/age plot

```{r test-lung-sex, include=FALSE}
tab_lung_sex <- table(lung$Sex, lung$Stage)

fisher.test(tab_lung_sex)

chi_lung_sex <- chisq.test(tab_lung_sex)
chi_lung_sex
p_lung_sex <- chi_lung_sex$p.value
```

```{r test-lung-race, include=FALSE}
tab_lung_race <- table(lung$Race, lung$Stage)

fisher.test(tab_lung_race, workspace = 2000000/4)

chi_lung_race <- chisq.test(tab_lung_race)
chi_lung_race
p_lung_race <- chi_lung_race$p.value
```

```{r plot-lung-age, message=FALSE, warning=FALSE}
ggplot(
  data = lung,
  aes(
    Age,
    fill = Stage,
    color = Stage
  )
) +
  geom_density(alpha=0.3) +
  xlim(20, 100)

ggplot(data = lung, aes(Age)) +
  geom_histogram() +
  facet_grid(rows="Stage") +
  xlim(20, 100)
```

```{r test-lung-age, include=FALSE}
wilc_lung_age <- wilcox.test(
  lung %>% filter(Stage == "Advanced") %>% pull(Age),
  lung %>% filter(Stage == "Early") %>% pull(Age)
)

wilc_lung_age
p_lung_age <- wilc_lung_age$p.value

t.test(
  lung %>% filter(Stage == "Advanced") %>% pull(Age),
  lung %>% filter(Stage == "Early") %>% pull(Age)
)
```

## Table: Advanced stage percentages, by demographics

```{r categorical-assoc}
assoc_r <- all_data %>%
  count(cancer_type, Stage, Race) %>%
  mutate(Factor = "Race") %>% 
  rename(Level = Race)

assoc_s <- all_data %>%
  count(cancer_type, Stage, Sex) %>%
  mutate(Factor = "Sex") %>% 
  rename(Level = Sex)

assoc <- bind_rows(assoc_r, assoc_s) %>% 
  pivot_wider(names_from = c(cancer_type, Stage), values_from = n) %>%
  mutate(
    Colon_Denom = Colon_Early + Colon_Advanced,
    Lung_Denom = Lung_Early + Lung_Advanced,
    Colon_Rate = round(Colon_Advanced / Colon_Denom * 100, 1),
    Lung_Rate = round(Lung_Advanced / Lung_Denom * 100, 1),
    p_colon = case_when(Factor == "Race" ~ round(p_colon_race, 3), Factor == "Sex" ~ round(p_colon_sex, 3)),
    p_lung = case_when(Factor == "Race" ~ round(p_lung_race, 3), Factor == "Sex" ~ round(p_lung_sex, 3))
  ) %>%
  select(
    Factor, Level,
    Colon_Advanced, Colon_Denom, Colon_Rate, p_colon,
    Lung_Advanced, Lung_Denom, Lung_Rate, p_lung
  )
```

```{r displayable}
assoc %>% 
  arrange(Factor, desc(Lung_Denom)) %>% 
  unite(Colon_Advanced, Colon_Denom, col="Colon_VA", sep = " / ") %>% 
  unite(Colon_VA, Colon_Rate, col="Colon_VA", sep=" (") %>% 
  unite(Lung_Advanced, Lung_Denom, col="Lung_VA", sep = " / ") %>% 
  unite(Lung_VA, Lung_Rate, col="Lung_VA", sep=" (") %>% 
  mutate(across(c(Colon_VA, Lung_VA), ~ paste0(.x, ")"))) %>%   # neat trick to add close paren
  kable()
```

## Table: Age, by cancer type and advanced-stage status

```{r age-assoc, message=FALSE}
all_data %>% 
  group_by(cancer_type, Stage) %>% 
  summarise(across(Age, q123ms)) %>% 
  unite(Age_median, Age_q1, col="Median_Q1", sep = " (") %>% 
  unite(Median_Q1, Age_q3, col = "Median_Q1_Q3", sep = " - ") %>% 
  unite(Age_mean, Age_sd, col="Mean_SD", sep = " (") %>% 
  mutate(across(c(Median_Q1_Q3, Mean_SD), ~ paste0(.x, ")"))) %>% 
  mutate(P_value = case_when(
    cancer_type == "Colon" ~ round(p_colon_age, 3),
    TRUE ~ p_lung_age
  )) %>% 
  kable()
```




# Notes to self

## Associations needed to hypoth-test

- $P(s_1)$: gender $\sim t_{si} \times \{l, c\} \times \{v, g\}$, with quartiles
- $P(s_2)$: gender $\sim t_{ic} \times \{l, c\} \times \{v, g\}$, with quartiles
- $\rho(a_1)$: Age $\sim t_{si} \times \{l, c\} \times \{v, g\}$
- $\rho(a_2)$: Age $\sim t_{ic} \times \{l, c\} \times \{v, g\}$
- $\rho(t): t_{si} \sim t_{ic} \times \{l, c\} \times \{v, g\}$

Or in notation,

$$ \{s_1, s_2, a_1, a_2, t\} \times \{l, c\} \times  \{v, g\} = |\mathbb{V}| \cdot |\mathbb{C}| \cdot |\mathbb{S}| = 20$$

where $\mathbb{V}$ is what pair of variables you're correlating, $\mathbb{C}$ is `cancer_type`, and $\mathbb{S}$ is `site`.

## Shell table for me

Too abstract for paper

```{r shell-table}
tribble(
  ~v1, ~v2, ~cancer, ~site,  ~pval,
  "Sex",  "t_si", "Lung", "Geisinger", "tk",
  "sex", "t_si", "Colon", "Geisinger",  "tk",
) %>% 
  kable()
```

It's really only 2 gender correlations ($s_1, s_2$) that we test with Wilcoxon, but it's times 4 strata, so that's 8 tests. Best to have a Wilcoxon function for this table.

# Associations: chart review

## Table: stratified $P$ values (gender)

```{r good-wilcox}
reviewed_all %>%
  group_by(site, cancer_type) %>%
  filter(!is.na(signal_to_init), !is.na(Sex)) %>%
  summarise(
    across(
      c(signal_to_init, init_to_completion),
      ~ wilcox.test(. ~ Sex)$p.value,
      .names = "p_Sex_{.col}"
    )
  )
```

## Initiation time vs. gender plot

```{r init-gender, message=FALSE, warning=FALSE}
reviewed_all %>% 
  filter(!is.na(Sex)) %>% 
  ggplot(aes(signal_to_init)) +
  geom_histogram() +
  facet_grid(rows=vars(Sex), cols = vars(site, cancer_type))
```

## Completion time vs. gender plot

```{r completion-gender, message=FALSE, warning=FALSE}
reviewed_all %>% 
  filter(!is.na(Sex)) %>% 
  ggplot(aes(init_to_completion)) +
  geom_histogram() +
  facet_grid(rows=vars(Sex), cols = vars(site, cancer_type))
```

## Table: Time intervals vs. gender

```{r time-gender-table}
reviewed_all %>% 
  # filter(!is.na(Sex)) %>%   # Don't filter for now, so we see when NAs are present.
  group_by(site, cancer_type, Sex) %>% 
  summarise(across(signal_to_init:init_to_completion, q123ms), n=n()) %>% 
  select(!contains(c("mean", "sd"))) %>% 
  unite(signal_to_init_median, signal_to_init_q1, col="signal_to_init", sep=" (") %>% 
  unite(signal_to_init, signal_to_init_q3, col="signal_to_init", sep=" - ") %>% 
  unite(init_to_completion_median, init_to_completion_q1, col="init_to_completion", sep=" (") %>% 
  unite(init_to_completion, init_to_completion_q3, col="init_to_completion", sep=" - ") %>% 
  mutate(across(contains("to"), ~ paste0(.x, ")"))) %>% 
  kable()
```

\newpage




# Associations: continuous vs. continuous

## Initiation time vs. age plot

```{r helper-fns}
p <- function(spear){
  return(round(spear$p.value, 3))
}

r <- function(spear){
  return(round(spear$estimate, 3))
}
```

```{r ia-test}
sp_ia <- cor.test(temporal$Age, temporal$sig_to_init, method = "spearman")
# FIXME: 
# make it use reviewed_all
# filter NA 
# stratify
```

Wrong: $P = `r p(sp_ia)`$

Wrong: $\rho = `r r(sp_ia)`$

```{r ia-plot}
ggplot(temporal, aes(x=Age, y=sig_to_init)) +
  geom_jitter(alpha=0.5) +
  scale_y_log10()
# FIXME (reviewed_all, filter, stratify)
```




# DIGRESSION: Exploratory analysis

### Sanity check

These should be the same:

```{r sanity}
g  <- cor.test(temporal$Age, temporal$sig_to_init, method = "spearman")
gv <- cor.test(temporal_gv$Age, temporal_gv$sig_to_init, method = "spearman")
p(g)
p(gv)
r(g)
r(gv)

temporal_gv %>% filter(site == "Geisinger", is.na(sig_to_init)) %>% select(cancer_type, signal_date, dx_eval_init_date, MOD_definite, signal_present) %>% summary()

temporal_gv %>% 
  mutate(sina = is.na(sig_to_init), icna = is.na(init_to_complete)) %>% 
  count(site, cancer_type, signal_present, sina, icna) %>% 
  arrange(sina) %>% 
  kable()
```

*Lesson:* Something weird about how cor.test handles NAs.

*Lesson:* Basically, there are (only) $n_l = 65$ Geisinger lung and $n_c = 70$ Geisinger colon with "temporality" data. $n = n_l + n_c = 135$. And the following predicates map 1:1 in the crosstabulation:

- `signal_present = "Yes"`
- `!is.na(sig_to_init)`
- `!is.na(init_to_complete)`

**Note to self!** Maybe (probably) I need to select only for those with red flag, meaning `signal_present = "Yes"`.


### How can you get negative numbers?

Workup completed (exactly one year) *before* workup initiated?

```{r negatives}
temporal_gv %>%
  filter(signal_present=="Yes", sig_to_init < 0 | init_to_complete < 0) %>%
  select(cancer_type, sig_to_init, init_to_complete, signal_date, dx_eval_init_date, dx_eval_complete_date) %>% 
  kable()
```

I suspect there are entry errors in year here.

### Correct stats: Non-NA `cor.test`

(Starting with correlation of `Age` and `sig_to_init`, like we did under "Sanity Check," above.)

```{r non-na-spearman}
t_all <- temporal_gv %>%
  filter(signal_present=="Yes", !is.na(sig_to_init)) %>%
  select(cancer_type, site, Age, sig_to_init, init_to_complete, Reviewer)

cor_ic <- cor.test(t_all$sig_to_init, t_all$init_to_complete, method = "spearman")
cor_ac <- cor.test(t_all$Age, t_all$init_to_complete, method = "spearman")
cor_ai <- cor.test(t_all$Age, t_all$sig_to_init, method = "spearman")

cor_ic
cor_ac
cor_ai

tribble(
  ~var1, ~var2, ~p.value, ~rho,
  "sig_to_init", "init_to_complete", cor_ic$p.value, cor_ic$estimate,
  "Age", "init_to_complete", cor_ac$p.value, cor_ac$estimate,
  "Age", "sig_to_init", cor_ai$p.value, cor_ai$estimate
) %>% 
  mutate(
    neg_log_p = round(-1 * log10(p.value), 1),
    across(c(p.value, rho), ~ round(., 3))
  ) %>% 
  kable()
```

### Interval plot

```{r wacky-time-plot}
t_all %>% 
  filter(cancer_type == "Lung") %>% 
  # arrange(sig_to_init + init_to_complete) %>% 
  arrange(sig_to_init) %>% 
  mutate(
    sig_to_complete = sig_to_init + init_to_complete,
    patient_id = row_number(),
    vmin = sig_to_init,
    vmax = sig_to_complete
  ) %>% 
  pivot_longer(
    cols = c("sig_to_init", "sig_to_complete"),
    names_to = "interval_type",
    names_prefix = "sig_to_"
  ) %>% 
  ggplot(aes(x = value, y = patient_id)) +
  geom_point(aes(shape = factor(interval_type), colour = factor(Reviewer))) +
  geom_linerange(aes(xmin = vmin, xmax=vmax, color=factor(Reviewer))) +
  geom_linerange(aes(xmin = 0, xmax=vmin, color=factor(Reviewer)), alpha = 0.2) +
  scale_x_sqrt()
```

### Reviewer bias?

```{r exploratory-reviewer-bias}
t_all %>% 
  pivot_longer(cols = c(sig_to_init, init_to_complete), names_to = "varname") %>% 
  filter(cancer_type=="Lung") %>% 
  group_by(Reviewer, varname) %>% 
  summarise(
    mean = mean(value),
    sd = sd(value),
    median = median(value),
    q1 = quantile(value, 0.25),
    q3 = quantile(value, 0.75)
  ) %>% 
  arrange(desc(varname)) %>% 
  kable()

r_si <- t_all %>% filter(cancer_type=="Lung",
                         Reviewer=="MRR") %>% pull(sig_to_init)
r_ic <- t_all %>% filter(cancer_type=="Lung",
                         Reviewer=="MRR") %>% pull(init_to_complete)
s_si <- t_all %>% filter(cancer_type=="Lung",
                         Reviewer=="SK") %>% pull(sig_to_init)
s_ic <- t_all %>% filter(cancer_type=="Lung",
                         Reviewer=="SK") %>% pull(init_to_complete)

t_all %>% 
  filter(cancer_type=="Lung") %>% 
  ggplot(aes(init_to_complete, factor(Reviewer))) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), color = "#777777") +
  geom_jitter(width = 0, height=0.25, alpha = 0.4) +
  scale_x_sqrt()

t_all %>% 
  filter(cancer_type=="Lung") %>% 
  ggplot(aes(sig_to_init, factor(Reviewer))) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), color = "#777777") +
  geom_jitter(width = 0, height=0.25, alpha = 0.4) +
  scale_x_sqrt()

wilcox.test(r_si, s_si)
wilcox.test(r_ic, s_ic)
```

\newpage




# End of digression. FIXME: wrong stats still in this section.

Is it Spearman that does not like `NA`? **No.** Really it's that `temporal` only ever used to use lung! It ignored colon.

## Completion time vs. age (multiple plots)

```{r ca}
sp_ca <- cor.test(temporal$Age, temporal$init_to_complete, method = "spearman")  # stat significant
# FIXME: same as other cor.test. (reviewed_all, filter, stratify)
```

$P = `r p(sp_ca)`$

$\rho = `r r(sp_ca)`$

```{r completion-age-plots}
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  xlim(40, 90) +
  scale_y_log10()
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_bin_2d(bins=10) +
  coord_cartesian(xlim=c(40,90)) +
  scale_y_continuous(breaks = seq(0,6000, 365*2))
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  coord_cartesian(xlim=c(40,90), ylim=c(-10, 600)) +   # probably always use coord_ with _smooth
  scale_y_continuous(breaks = seq(0,6000, 365), minor_breaks = seq(0, 6000, 365/12))
ggplot(temporal, aes(x=Age, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  coord_cartesian(xlim=c(40,90), ylim=c(-10, 120)) +
  scale_y_continuous(breaks = seq(0,6000, 30), minor_breaks = seq(0, 6000, 30/4))

# FIXME (reviewed_all, filter, stratify)
# yes this applies to these plots.
```

\newpage

## Initiation time vs. completion time (plots are too wacky)

```{r ic}
sp_ic <- cor.test(temporal$sig_to_init, temporal$init_to_complete, method = "spearman")  # stat significant
# FIXME (reviewed_all, filter, stratify)
```

$P = `r p(sp_ic)`$

$\rho = `r r(sp_ic)`$

```{r init-completion-wacky-plots}
ggplot(temporal, aes(x=sig_to_init, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  scale_y_log10() + scale_x_log10()
ggplot(temporal, aes(x=sig_to_init, y=init_to_complete)) +
  geom_hex(bins=10) +
  scale_y_log10() + scale_x_log10()
ggplot(temporal, aes(x=sig_to_init + 0.1, y=init_to_complete + 0.1)) +
  geom_density_2d() + geom_jitter(alpha=0.5) +
  scale_y_log10() + scale_x_log10()
ggplot(temporal, aes(x=sig_to_init, y=init_to_complete)) +
  geom_jitter(alpha=0.5) +
  geom_smooth() +
  coord_cartesian( xlim=c(0, 365*2), ylim=c(0,1200))+
  scale_x_continuous(breaks = seq(0,2000,365)) +
  scale_y_continuous(breaks = seq(0,2000,365))
# FIXME (reviewed_all, filter, stratify)
```
